var trup,init,fire,lfgs,sycl,cfgo,uris,clip,dast,perm,blak,scbr,exts,down,D=!1;
Registry.require("statistics convert xmlhttprequest downloads cache storage uri compat parser helper syncinfo notify asker i18n native".split(" "),function(){var sa=function(a){D|=60<=a;K.debug(!1);p.debug(D,!1);N.debug(D)},n=Registry.prepare(!0),v=$.Deferred,w=function(a){var c=v();c.resolve(a);return c.promise()},O=function(){var a=v();a.reject();return a.promise()},ja=function(){var a=[],c=!0,b=function(a,b,d){var g={title:a.join("\n\n")};console.warn(a.join("\n"));chrome.browserAction.setIcon(b);
chrome.browserAction.setTitle(g);b=function(g,d,b){g={name:"1",sub_menu_item:!0,pos:"left",items:[]};g.items.push({name:a[0],image:"info"});1<a.length&&g.items.push({name:a[1]});b({items:[g],options:{enabled:!1}})};d||chrome.extension.onMessage.addListener(b)};return{run:function(){try{if(Registry.verify("202").length){var a=["Tampermonkey detected that Chrome is caching some outdated code parts.","In order to avoid unexpected behavior TM will be kept paused until Chrome was restarted."],
l={path:chrome.extension.getURL("images/icon_paused.png")};c=!1;b(a,l)}else chrome.extension.inIncognitoContext&&n.RUNTIME.CHROME&&28>n.RUNTIME.BROWSER_VERSION&&(a=["Tampermonkey detected that it can not work in incognito mode with your browser version.","Please update your browser to version 28 or higher."],l={path:chrome.extension.getURL("images/icon_paused.png")},c=!1,b(a,l))}catch(d){c=!1,console.error(d.message)}"chromeStorage"!=n.DB.USE||n.DB.NO_WARNING||window.setTimeout(function(){p.isWorking().fail(function(){confirm("Tampermonkey detected that your Chrome profile is broken!\n\nUnfortunately all extension data including your settings and userscripts is stored at the profile.\n\nDo you want to visit the FAQ entry that explains how to recover from that?")&&
chrome.tabs.create({url:"http://tampermonkey.net/faq#Q206"},function(){});var a={path:chrome.extension.getURL("images/icon_paused.png")};b(["Tampermonkey detected that your Chrome profile is broken!"],a,!0)})},1E3);return c},pause:b,setWarning:function(b,c,d){a.push({text:b,description:c,url:d})},getWarnings:function(){return a}}}();if(ja.run()){var G=n.WEBREQUEST;D&&console.debug("Starting background fred @"+ta);var s=Registry.get("helper"),X=Registry.get("cache"),Z=Registry.get("statistics"),p=
Registry.get("storage"),N=Registry.get("notify"),ka=Registry.get("asker"),P=Registry.get("native"),U=Registry.get("permission"),Ea=Registry.get("icon");perm=U;dast=p;var ta=s.createUUID(),Q={},ca={};X.create("rundata").setOptions({timeout:180,check_interval:120,retimeout_on_get:!0}).init();X.create("resources").setOptions({timeout:1800,check_interval:300}).init();var R=function(a,c){for(var b=function(a){return a?s.filter(a.replace(/-/g,"."),/[\.0-9]/g):""},f=b(a),b=b(c),f=f.split("."),b=b.split("."),
l=f.length<b.length?f.length:b.length,d=0;d<l;d++){f.length<l&&(f[d]=0);b.length<l&&(b[d]=0);if(Number(f[d])>Number(b[d]))return 1;if(Number(f[d])<Number(b[d]))return-1}return b.length<f.length?1:0};chrome.extension.manifest=function(){var a=chrome.extension.getURL("manifest.json"),c;try{if(a&&-1!=a.search("{"))c=JSON.parse(a);else{var b=new XMLHttpRequest;b.open("GET",a,!1);b.send(null);c=JSON.parse(b.responseText)}}catch(f){console.log("getVersion"+f.message),c={version:"0.0.0.0",name:"Tampermonkey"}}return c}();
chrome.extension.getVersion=function(){return chrome.extension.manifest.version};chrome.extension.getName=function(){return chrome.extension.manifest.name};var Ga=function(){var a=v(),c=chrome.extension.getVersion(),b=p.getSchemaVersion(),f=b;p.isWiped().then(function(a){a&&(a=["Tampermonkey detected inconsistencies that indicate that Chrome wiped the extension database!","You can continue to use Tampermonkey normally, but your settings and scripts might be lost. Click here to get more information.",
"http://tampermonkey.net/faq.php#Q207"],console.warn(a.join("\n")),ja.setWarning.apply(this,a));return p.getVersion("0.0.0.0")}).always(function(l){var d=1==R(c,l),g=[],m=0,k=function(){if(m<g.length){var d=g[m].schema;g[m].cond(d)?g[m].fn().done(function(){d&&(console.log("Converted database from",f,"to",d),f=d);window.setTimeout(k,n.MISC.TIMEOUT)}).fail(function(){a.reject()}):window.setTimeout(k,n.MISC.TIMEOUT);m++}},e=function(){console.warn("Incognito mode detected. Database conversion can only be done in non-incognito mode! Stopping now...");
var a={path:chrome.extension.getURL("images/icon_paused.png")};ja.pause(["Tampermonkey needs to convert its database but this can't be done in incogonito mode!","Please open a non-incognito mode window and/or restart your browser."],a)},g=[{cond:function(){return d&&"chromeStorage"==n.DB.USE&&!p.getValue(n.CONSTANTS.STORAGE.LEGACY_VERSION)&&1==R("3.5.3603",l)},fn:function(){var a=v();chrome.extension.inIncognitoContext?(e(),a.reject()):(console.log("Update database..."),f="3.5.3603",p.migrate("sql",
"chromeStorage").done(function(){console.log("Copied config for default usage of chrome.storage");a.resolve()}));return a.promise()}},{cond:function(){return d&&1==R("3.6.3650",f)&&1==R("3.5.3650",l)},fn:function(){var a=v();if(chrome.extension.inIncognitoContext)e(),a.reject();else{f="3.6.3650";var d=[];[{o:"TM_config",n:n.CONSTANTS.STORAGE.CONFIG},{o:"TM_update_check",n:n.CONSTANTS.STORAGE.UPDATE},{o:"TM_version"},{o:"TM_unload_ts"}].forEach(function(a){if(a.n){var g=p.getValue(a.o);void 0!==g&&
d.push(p.setValue(a.n,g))}d.push(p.deleteValue(a.o))});var g=/@re$/,b=[];p.listValues().forEach(function(a){-1!=a.search(g)&&(a=a.replace(g,""),b.push(a))});b.forEach(function(a){var g=p.getValue(a+"@st"),b=p.getValue(a),c=p.getValue(a+"@re"),k=p.getValue(a+"@source"),m=z.getUidByName(a)||s.createUUID();d.push(p.deleteValue(a+"@st"));d.push(p.deleteValue(a));d.push(p.deleteValue(a+"@re"));d.push(p.deleteValue(a+"@source"));b&&c&&k?(d.push(p.setValue(n.CONSTANTS.PREFIX.SCRIPT_UID+m,a)),d.push(p.setValue(n.CONSTANTS.PREFIX.COND+
m,c)),d.push(p.setValue(n.CONSTANTS.PREFIX.STORE+m,g)),d.push(p.setValue(n.CONSTANTS.PREFIX.SCRIPT+m,k)),d.push(p.setValue(n.CONSTANTS.PREFIX.META+m,b))):console.warn("invalid script entry",{source:k,meta:b,cond:c})});g=/@st$/;p.listValues().forEach(function(a){-1!=a.search(g)&&d.push(p.deleteValue(a))});$.when.apply($,d).done(function(){console.log("Converted database from",l,"to",f);a.resolve()})}return a.promise()}},{schema:"3.7.0",cond:function(a){return 1==R(a,f)},fn:function(){var a=v();if(chrome.extension.inIncognitoContext)e(),
a.reject();else{var d=[],g=RegExp("^"+n.CONSTANTS.PREFIX.META);p.listValues().forEach(function(a){if(-1!=a.search(g)){var b=p.getValue(a);b.options&&b.options.override&&!b.options.override.orig_run_at&&(b.options.override.orig_run_at=b.options.run_at||"document-end",b.options.run_at=null,d.push(p.setValue(a,b)))}});$.when.apply($,d).done(function(){a.resolve()})}return a.promise()}},{schema:"4258",cond:function(a){return 1==R(a,f)},fn:function(){var a=v();if(chrome.extension.inIncognitoContext)e(),
a.reject();else{var d=p.getValue(n.CONSTANTS.STORAGE.CONFIG);d&&d.sync_enabled&&2==d.sync_type&&(d.sync_version=1,p.setValue(n.CONSTANTS.STORAGE.CONFIG,d));a.resolve()}return a.promise()}},{cond:function(){return d||1==R(f,b)},fn:function(){var a=v();p.setVersion(c,f).done(function(){a.resolve()});return a.promise()}},{cond:function(){return d},fn:function(){console.log("First run of version "+c+"!");Fa.scheduleNotification(l,"0.0.0.0"==l);return w()}},{cond:function(){return!0},fn:function(){var d=
v();a.resolve();window.setTimeout(d.resolve,n.MISC.TIMEOUT);return d.promise()}}];k()});return a.promise()},ua=function(){var a={get:function(a,b){var f=(0==a)+"#"+b,l=X.items.rundata.getj(f);if(l)l.oldret.user_agent[a]=l.oldret.user_agent[l.frameId],l=l.oldret;else{for(var l=u.determineScriptsToRun(b),d=[],g=0,m={},k={},e=0;e<l.length;e++){var t=l[e];if(!t.enabled)g++;else if(0==a||!0!==t.options.noframes&&(null!==t.options.noframes||!0!==t.options.override.orig_noframes))t.options.user_agent&&(k[a]=
t.options.user_agent),m[t.name]=!0,d.push(t)}l={runners:d,disabled:g,script_map:m,user_agent:k};X.items.rundata.setj(f,{frameId:a,oldret:l})}return l},getUserAgent:function(c,b){return a.get(c,b).user_agent}};return a}(),y=function(){var a={},c=1,b=c++,f=c++,l=c++,d=c++,g=c++,m=c++,k=c++,e=c++,t=c++,r=function(){var a={frames:{0:{state:b}},tabs:{reset_ts:(new Date).getTime()},scripts:{},urls:{},maps:{},contexts:{onUnload:{}},stats:{running:0,disabled:0},extra:{}};Object.defineProperties(a.urls,{length:{value:0,
enumerable:!1,writable:!0,configurable:!0}});return a},q={_info:function(){return a},listeners:{_onReset:[],_onCommited:[],_onCompleted:[],add:{onReset:function(a){q.listeners._onReset.push(a);return q.listeners._onReset.length-1},onCommited:function(a){q.listeners._onCommited.push(a);return q.listeners._onCommited.length-1},onCompleted:function(a){q.listeners._onCompleted.push(a);return q.listeners._onCompleted.length-1}},remove:{onReset:function(a){q.listeners._onReset[a]=null},onCommited:function(a){q.listeners._onCommited[a]=
null},onCompleted:function(a){q.listeners._onCompleted[a]=null}}},events:{reset:function(d,g){a[d]=r();a[d].frames[0].state=b;s.each(q.listeners._onReset,function(a,b){a&&a(d,g)})},request:function(d,g,b){h.values.enabled&&(a[d]=a[d]||r(),a[d].frames[g]=a[d].frames[g]||{},a[d].frames[g].state=f,b=B.woHash(b),b=ua.getUserAgent(g,b),b[g]&&q.set.extra(d,g,"user_agent",b[g]))},response:function(d,g,c){if(h.values.enabled){a[d]=a[d]||r();a[d].frames[g]=a[d].frames[g]||{};var k=a[d].frames[g].state||b;
a[d].frames[g].state=l;0===g&&(a[d].tabs.response_ts=(new Date).getTime());if(k<l)return c=B.woHash(c),q.scripts.determine(d,g,c)}},commited:function(g,c,k){if(h.values.enabled){var m=B.parse(k);if("http:"===m.protocol||"https:"===m.protocol||"file:"===m.protocol)a[g]=a[g]||r(),a[g].frames[c]=a[g].frames[c]||{},m=a[g].frames[c].state||b,a[g].frames[c].state=d,m<l&&(k=B.woHash(k),q.scripts.determine(g,c,k)),s.each(q.listeners._onCommited,function(a,d){a&&a(g)})}},loading:function(d,c,k){if(h.values.enabled){var m=
B.parse(k);"http:"!==m.protocol&&"https:"!==m.protocol&&"file:"!==m.protocol||0!==c||"file:"!==m.protocol||(a[d]=a[d]||r(),a[d].frames[c]=a[d].frames[c]||{},m=a[d].frames[c].state||b,a[d].frames[c].state=g,m<l&&(k=B.woHash(k),q.scripts.determine(d,c,k)))}},prepare:function(d,g,b,c){if(h.values.enabled){var k=0===g?g:b;a[d]=a[d]||r();a[d].frames[k]=a[d].frames[k]||{};c=B.woHash(c);a[d].frames[k].state=m;k=a[d].scripts[c];k||(q.scripts.determine(d,g,c),k=a[d].scripts[c]);g=k.runners.length;q.scripts.updateMaps(d,
b,k.script_map);q.scripts.updateUrls(d,b,c);return g}},run:function(d,g,b,c,m){if(h.values.enabled){var f=0===g?g:b;a[d]=a[d]||r();a[d].frames[f]=a[d].frames[f]||{};a[d].frames[f].state=k;var l=B.woHash(c);if(c=a[d].scripts[l])q.scripts.updateStats(d,b,c.runners.length,c.disabled),q.scripts.run(d,g,b,l,c.runners,function(){a[d]&&delete a[d].scripts[l];m&&m()});else{var e;D&&(e=a[d].scripts);console.warn("tv: no script run info for tab "+d+" @ "+l,e)}}},complete:function(d,g,c){c=B.parse(c);if(h.values.enabled&&
("http:"===c.protocol||"https:"===c.protocol||"file:"===c.protocol)){if(0===g){a[d]=a[d]||r();a[d].frames[g]=a[d].frames[g]||{};var m=a[d].frames[g].state||b;a[d].frames[g].state=e;if(!y.get.empty(d)&&y.get.stats(d).running){if(m<k){console.warn("tv: no script run info!");return}"file:"===c.protocol?window.setTimeout(function(){chrome.tabs.sendMessage(d,{method:"onLoad",frameId:g},function(a){})},500):(chrome.tabs.sendMessage(d,{method:"onLoad",frameId:g},function(a){}),I.runCheck&&chrome.contentSettings.javascript.clear({}))}}s.each(q.listeners._onCompleted,
function(a,g){a&&a(d)})}},unload:function(d,g,b){g=0===g?g:b;a[d]=a[d]||r();a[d].frames[g]=a[d].frames[g]||{};a[d].frames[g].state=t;if(a[d]&&a[d].contexts.onUnload[b]){for(g=0;g<a[d].contexts.onUnload[b].length;g++)a[d].contexts.onUnload[b][g]();a[d].contexts.onUnload[b]=[]}},remove:function(d){delete a[d]}},scripts:{updateStats:function(d,g,b,c){a[d].stats.running+=b;a[d].stats.disabled+=c;a[d].contexts.onUnload[g]=a[d].contexts.onUnload[g]||[];a[d].contexts.onUnload[g].push(function(){a[d].stats.running-=
b;a[d].stats.disabled-=c});a[d].tabs.ts=(new Date).getTime()},updateMaps:function(d,g,b){var c=1,k=function(g,b){void 0===a[d].maps[b]&&1===c&&(a[d].maps[b]=0);a[d].maps[b]+=c};s.each(b,k);a[d].contexts.onUnload[g]=a[d].contexts.onUnload[g]||[];a[d].contexts.onUnload[g].push(function(){a[d]&&(c=-1,s.each(b,k))})},updateUrls:function(d,g,b){var c=1,k=function(){void 0===a[d].urls[b]&&1===c&&(a[d].urls[b]=0);a[d].urls[b]+=c;a[d].urls.length=-1};k();a[d].contexts.onUnload[g]=a[d].contexts.onUnload[g]||
[];a[d].contexts.onUnload[g].push(function(){a[d]&&(c=-1,k())})},determine:function(d,g,b){g=ua.get(g,b);a[d].scripts[b]=g;return g.runners.length},run:function(a,d,g,b,c,k){for(var m=[],f=n.RUNTIME.ALLOWS_FAST_DOCUMENT_START&&h.values.runtime_fastDocumentStart,l=0;l<c.length;l++){var e=c[l];e.options.user_agent||e.evilness&&!(e.evilness<h.values.script_blacklist_severity)||m.push(Ha.inject({tabId:a,frameId:d,contextId:g,url:b},e,f&&("document-start"===e.options.run_at||!e.options.run_at&&"document-start"===
e.options.override.orig_run_at)))}$.when.apply($,m).always(function(){k&&k()})}},set:{extra:function(d,g,b,c){a[d]=a[d]||r();null===g?a[d].extra[b]=c:(a[d].extra[b]=a[d].extra[b]||{},a[d].extra[b][g]=c)},blocker:function(a,d){q.set.extra(a,null,"blocker",!0)},forbidden:function(a,d,g){0===d&&q.set.extra(a,null,"forbidden",!0)},fire:{count:function(a,d){q.set.extra(a,null,"fire_count",d)}}},get:{extra:function(d,g,b,c){void 0===c&&(c=null);var k=null,k=(a[d]?a[d].extra:{})[b];null!==g&&k&&(k=k[g]);
return k||c},empty:function(d){var g=!0;if(a[d]&&0!=a[d].urls.length){if(-1==a[d].urls.length)return a[d].urls.length=0,s.each(a[d].urls,function(g,b){"length"!==b&&0<g&&a[d].urls.length++}),q.get.empty(d);g=!1}return g},fire:{count:function(a){return q.get.extra(a,null,"fire_count")}},urls:function(d){return a[d]?a[d].urls:{}},stats:function(d,g){var b={};if(a[d]&&(b.running=a[d].stats.running,b.disabled=a[d].stats.disabled,g)){b.unique=0;for(var c in a[d].maps)a[d].maps.hasOwnProperty(c)&&0<a[d].maps[c]&&
b.unique++}return b},tabs:function(){var d={};s.each(a,function(a,g){d[g]={ts:a.response_ts}});return d},blocker:function(a){return q.get.extra(a,null,"blocker")},forbidden:function(a,d,g){return q.get.extra(a,null,"forbidden")},user_agent:function(a,d){return q.get.extra(a,d,"user_agent")}}};return q}(),wa=function(){return{isScriptUrl:function(a){if(!a||-1!=a.search(/\#bypass=true/)||-1!=a.search(n.REQUESTS.GET_INTERNAL_PAGE_REGEXP()))return!1;a=a.split(/[\?#$]/)[0];var c=-1!=a.search(/\.user\.(js\#|js\?|js$)/)||
-1!=a.search(/\.tamper\.(js\#|js\?|js$)/);return c?!(-1!=a.search(/^htt[ps]{1,2}:\/\/code\.google\.com/)||-1!=a.search(/^htt[ps]{1,2}:\/\/github\.com/)&&-1==a.search(/^htt[ps]{1,2}:\/\/github\.com\/[a-zA-Z0-9%-]\/[a-zA-Z0-9%-]\/raw\//)):c}}}(),xa=function(){var a=function(a){var b=v(),f=(new Date).getTime();a.url+=-1!=a.url.search("\\?")?"&":"?";a.url+="ts="+f;var f=function(d){if(4==d.readyState&&(200==d.status||0==d.status))if("arraybuffer"==l.responseType){if(d.response){b.resolve({decoded:!0,
encoding:a.encoding,content:M.arrbuf2str(d.response,a.encoding)});return}}else if(null!==d.response&&void 0!==d.response){b.resolve({decoded:!0,encoding:a.encoding,content:d.response});return}b.reject({content:""})},l={method:"GET",retries:0,responseType:"arraybuffer",url:a.url};if(a.sync){var d=V(l,{});4==d.readyState&&403==d.status&&(delete l.responseType,d=V(l,{}));f(d)}else V(l,{ondone:f});return b.promise()};return{getSource:function(c){"string"===typeof c&&(c={url:c});return a(c)}}}();lfgs=
xa;var la=function(){return{isAllowed:function(a){var c=!1,b=!1,f=0!=h.values.forbiddenPages.length,l=0!=h.values.page_whitelist.length;switch(h.values.page_filter_mode){case "black":b=f;break;case "off":break;case "white":c=l;break;default:c=l,b=f}f={inc:c?h.values.page_whitelist:void 0,exc:b?h.values.forbiddenPages:void 0};return!b&&!c||u.validUrl(a,f)}}}(),da=function(){var a={init:function(){var c=v(),b=function(){"server"===h.values.script_blacklist_type&&window.setTimeout(a.checkUpdate,2E4)};
b();h.addChangeListener("script_blacklist_type",b);c.resolve();return c.promise()},getEvilnessOf:function(a){if("off"===h.values.script_blacklist_type)return!1;if(!a)return 0;var b=!1,f=0,l=function(d){var g=!1;if(d.length)return(g="/"==d.substr(0,1)?u.matchUrl(a,d):-1!=a.search(d))&&console.debug('black: entry "'+d+'" matched'),b|=g,!0!=b};s.each(h.values.require_blacklist,l);b?f=11:"server"===h.values.script_blacklist_type&&s.each(h.values.script_blacklist_server,function(a){if(a&&(s.each(a.rules,
function(a){l(a);return!0!=b}),b))return f=a.severity,!1});return Number(f)},checkUpdate:function(a){var b=v(),f=S.getConfig(),l;if(a||864E5<(new Date).getTime()-f.black.last){var d=function(a){var d=v();V({method:"GET",url:a,retries:n.XMLHTTPREQUEST.RETRIES,overrideMimeType:"text/plain; charset=x-user-defined"},{ondone:function(a){d.resolve(a)}});return d.promise()};d("http://blacklist.tampermonkey.net/get.php?version=get").then(function(g){if(4==g.readyState&&200==g.status){try{l=JSON.parse(g.responseText).version}catch(b){console.log("black: unable to parse version response! "+
g.responseText)}console.log("black: local version: "+f.black.version+" remote: "+l);if(l>f.black.version||a)return d("http://blacklist.tampermonkey.net/get.php")}}).then(function(a){if(a&&4==a.readyState&&200==a.status)try{var d=JSON.parse(a.responseText);d&&d.blacklist&&1==d.version&&(h.values.script_blacklist_server=d.blacklist);console.log("black: updated blacklist to ",d)}catch(b){console.log("black: blacklist update failed! ",a.responseText)}}).always(function(){f=S.getConfig();f.black.last=
(new Date).getTime();f.black.version=l||f.black.version;S.setConfig(f);b.resolve()})}else b.resolve();return b.promise()}};return a}();blak=da;var F=function(){var a={fireDB:null,status:{initialized:!1,action:"Initializing"},resetStatus:function(c){void 0===c&&(c=!!a.fireDB);a.status={initialized:c,update:!1,download:!1,action:"",error:"",progress:{n:0,of:0}}},isReady:function(){return a.status.initialized&&!a.status.update&&!a.status.download},checkUpdate:function(c,b,f,l){var d=c||b;if(d||0!=h.values.fire_updatePeriod&&
h.values.fire_enabled){var g=S.getConfig(),m=function(){l&&l(""==a.status.error)};if(a.status.update||a.status.download){f&&f(!0);var k=function(){a.isReady()?m():window.setTimeout(k,1E3)};l&&k()}else if(d||(new Date).getTime()-g.fire.last>h.values.fire_updatePeriod){var e=0,t=function(){a.update(c,function(d){""==a.status.error&&(g=S.getConfig(),g.fire.last=(new Date).getTime(),g.fire.db_version=e,g.fire.entries=d,S.setConfig(g));m()})},d={method:"GET",url:a.updateURL()+"&db_version=get",retries:n.XMLHTTPREQUEST.RETRIES,
overrideMimeType:"text/plain; charset=x-user-defined"};V(d,{onload:function(a){if(4==a.readyState){if(200==a.status){try{e=JSON.parse(a.responseText).db_version}catch(d){console.log("bg: fire: unable to parse DB version response! "+a.responseText)}console.log("bg: fire: local DB version: "+g.fire.db_version+" remote: "+e);a=e>g.fire.db_version||b;f&&f(a);if(a){t();return}}m()}},onerror:function(){a.status.error="Update check request failed!";m()}})}else m()}},updateURL:function(){return h.values.fire_getURL+
"?ts=0"},update:function(c,b){var f=null,l=2,d=null,g=1,m=null,k=0,x={},t=function(){f&&window.clearTimeout(f);f=null},r=function(){t();f=window.setTimeout(d,12E4)},q=function(d){return{method:"GET",url:a.updateURL()+"&part="+d,retries:n.XMLHTTPREQUEST.RETRIES,overrideMimeType:"text/plain; charset=x-user-defined"}},h=function(d){t();a.resetStatus();a.status.error=d;b&&b();console.log(e.getMessage("TamperFire_update_failed___")+" Error: "+d+" @ file:"+q(g).url);N.show("TamperFire",e.getMessage("TamperFire_update_failed___"),
chrome.extension.getURL("images/icon128.png"),3E4)},H=function(d){r();if(d.progress&&-1!=d.progress.totalSize){null==m&&(m=d.progress.totalSize);var b=60*m,c=d.progress.done+6*m*(g-1);c>b&&(c=b);a.status.progress={n:c,of:b};D&&0==++k%50&&console.log("bg: fire download: "+d.progress.done+" bytes "+c+"/"+b)}},qa=function(c){r();if(4==c.readyState)if(200==c.status){t();var k={};c=c.responseText;try{k=JSON.parse(c)}catch(m){if(-1!=c.search("<body>")){var f=c.indexOf("<body>"),q=c.lastIndexOf("</body>");
-1!=f&&-1!=q&&(c=c.substr(f+6,q-(f+6)))}try{k=JSON.parse(c)}catch(H){h("Parse Error! Update URL: ",a.updateURL(),H);return}}c=null;if(k.scripts){for(var n in k.scripts)x[n]=k.scripts[n];k=null;if(10>g)D&&console.log("bg: fire: download of file "+g+" succced"),g++,l=2,d();else{a.resetStatus();a.status.update=!0;a.status.action=e.getMessage("Update_in_progress");var qa=function(d){!1===d?a.resetStatus(!1):(a.status.update=!0,a.insertValuesFromJSON({scripts:x},function(d){a.resetStatus();console.log(e.getMessage("TamperFire_is_up_to_date"));
N.show("TamperFire",e.getMessage("TamperFire_is_up_to_date"),chrome.extension.getURL("images/icon128.png"),3E4);b&&b(d)}),x=null)};a.clean(function(){a.initTables(qa)})}}else h("Invalid Content! Update URL: "+a.updateURL())}else h("Update URL: "+c.status);else console.log(c)},d=function(){0<l?(a.status.action=e.getMessage("Downloading"),a.status.download=!0,r(),V(q(g),{ondone:qa,onreadychange:H}),l--):h("Download failed!")};console.log(e.getMessage("TamperFire_update_started"));N.show("TamperFire",
e.getMessage("TamperFire_update_started"),chrome.extension.getURL("images/icon128.png"),3E4);c||chrome.tabs.create({url:chrome.extension.getURL("fire.html")},function(){});d()},init:function(c){a.resetStatus(!1);a.initTables(function(b){b=!1!==b;c&&c(b);b&&window.setTimeout(a.checkUpdate,2E4)})},clean:function(c){var b=function(){c&&c()},f=function(){a.fireDB.db.transaction(function(a){a.executeSql("DROP TABLE scripts",[],b,b)})},l=function(){a.fireDB.db.transaction(function(a){a.executeSql("DROP TABLE excludes",
[],f,f)})},d=function(){a.fireDB.db.transaction(function(a){a.executeSql("DROP TABLE includes",[],l,l)})},g=function(){a.fireDB.db.transaction(function(a){a.executeSql("DROP TABLE scriptexcludes",[],d,d)})};(function(){a.fireDB.db.transaction(function(a){a.executeSql("DROP TABLE scriptincludes",[],g,g)})})()},initTables:function(c){var b=function(){a.status.initialized=!0;c&&c()},f=null;try{f=window.openDatabase("tmFire","1.0","TamperFire",41943040)}catch(l){console.warn("Unable to open TamperFire database! ",
l.message);c&&c(!1);return}a.fireDB={db:f,onSuccess:function(a,d){},onError:function(a,d,g,b){console.error("fireDB Error",d);g&&console.warn(" @ statement "+g);b&&console.warn("        with "+JSON.stringify(b))},createScriptTable:function(d){var g=function(d,g){a.fireDB.onError(d,g);c&&c(!1)};a.fireDB.db.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS scripts(sid INTEGER PRIMARY KEY ASC, value TEXT)",[],d,g)})},createScriptIncludesTable:function(d){var g=function(d,g){a.fireDB.onError(d,
g);c&&c(!1)};a.fireDB.db.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS scriptincludes(iid INTEGER, sid INTEGER, FOREIGN KEY(sid) REFERENCES scripts(sid),FOREIGN KEY(iid) REFERENCES includes(iid))",[],d,g)})},createIncludesTable:function(d){var g=function(d,g){a.fireDB.onError(d,g);c&&c(!1)};a.fireDB.db.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS includes(iid INTEGER PRIMARY KEY ASC, generic BOOLEAN, regex TEXT)",[],d,g)})},createScriptExcludesTable:function(d){var g=
function(d,g){a.fireDB.onError(d,g);c&&c(!1)};a.fireDB.db.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS scriptexcludes(eid INTEGER, sid INTEGER, FOREIGN KEY(sid) REFERENCES scripts(sid),FOREIGN KEY(eid) REFERENCES excludes(eid))",[],d,g)})},createExcludesTable:function(d){var g=function(d,g){a.fireDB.onError(d,g);c&&c(!1)};a.fireDB.db.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS excludes(eid INTEGER PRIMARY KEY ASC, regex TEXT)",[],d,g)})}};var d=function(){a.fireDB.createScriptExcludesTable(b)},
g=function(){a.fireDB.createScriptIncludesTable(d)},m=function(){a.fireDB.createExcludesTable(g)};a.fireDB.createScriptTable(function(){a.fireDB.createIncludesTable(m)})},insertValuesFromJSON:function(c,b){var f=[],l=[],d={},g={},m=[],k=[],x=[],t=[],r=0,q=0;console.log(e.getMessage("TamperFire_import_started"));for(var fa in c.scripts)c.scripts.hasOwnProperty(fa)&&f.push(fa);a.status.action=e.getMessage("Processing_scripts");a.status.progress={n:0,of:f.length};var H=0,n,p=0,u=function(){for(var a in d){var g=
r++;m.push([a,d[a].generic,g]);for(var b in d[a].sids)x.push([g,d[a].sids[b]])}},v=function(){for(var a in g){var d=q++;k.push([a,d]);for(var b in g[a].sids)t.push([d,g[a].sids[b]])}},w=function(d,g,b,c){if(b.length){a.resetStatus();a.status.update=!0;a.status.action=e.getMessage("Writing_scripts");a.status.progress={n:d,of:m.length+k.length+x.length+t.length};var f=function(){w(d,g,b,c)},l=b.length-1;1E4<l-n&&(l=n+1E4);D&&console.log("bg: write TF "+l);g(b.slice(n,l),function(){n>=b.length-1?c&&
c():window.setTimeout(f,0)});n=l;a.status.progress.n=d+n}else c&&c()},z=function(d){l.length?(a.scripts.setValues(l,d),l=[]):d&&d()},y=function(){var d=function(){b&&b(f.length)},g=function(){n=0;w(p,a.scriptExcludes.setValues,t,d);p+=t.length},c=function(){n=0;w(p,a.scriptIncludes.setValues,x,g);p+=x.length},l=function(){n=0;w(p,a.excludes.setValues,k,c);p+=k.length};u();v();z(function(){n=0;w(p,a.includes.setValues,m,l);p+=m.length})},va=function(){1E4<l.length?z(va):(H++,0==H%96?window.setTimeout(A,
0):A())},A=function(){D&&0==H%2048&&console.log("bg: import TF script "+f[H]);a.status.progress.n=H;if(H<f.length){var b=c.scripts[f[H]];l.push([f[H],JSON.stringify(b)]);for(var k=0;k<b.excludes.length;k++){var m=B.getRegExpFromInclude(b.excludes[k],{safe:!0,tryToFixUrl:h.values.tryToFixUrl,safeUrls:h.values.safeUrls});g[m]||(g[m]={sids:[]});g[m].sids.push(f[H])}for(k=0;k<b.includes.length;k++){var e=b.includes[k].trim(),m=B.getRegExpFromInclude(e,{safe:!0,tryToFixUrl:h.values.tryToFixUrl,safeUrls:h.values.safeUrls});
if(!d[m]){var q=0;if(-1!=e.search("^(https?)?(://)?[w.]{0,4}[*|.]+[/]?$")||-1!=e.search("^[.*/]+$")||-1!=e.search("^"+s.escapeForRegExp("*://*[$|/]"))||""==e.replace(/(https|http|\*).:\/\/\*/,"")||"*"==e)q=1;d[m]={sids:[],generic:q.toString()}}d[m].sids.push(f[H])}va()}else y()};A()},count:function(c,b,f,l){a.getValues(c,b,[f],function(a){l(a.length)})},setValue:function(c,b,f,l,d,g){a.setValues(c,[b,l],[l,d],g)},setValues:function(c,b,f,l){for(var d=0,g=[],m=[],k=0;k<b.length;k++)g.push(b[k]),m.push("?");
var e=function(b){if(d<f.length){var k="INSERT INTO "+c+"("+g.join(", ")+") VALUES ("+m.join(", ")+");";b.executeSql(k,f[d],e,function(g,b){a.fireDB.onError(g,b,k,f[d]);e(g)});d++}else l&&l()};a.fireDB.db.transaction(e)},getValues:function(c,b,f,l){var d=0,g=null,m=[],k=function(a,g){if(g.rows)for(var b=0;b<g.rows.length;b++)m.push(g.rows.item(b));d<f.length?e():l(m)},e=function(m){g||(g=m);var l=[];m=[];for(var e=d;e<f.length&&20>e-d;e++)m.push(b+"=?"),l.push(f[e]);g.executeSql("SELECT * FROM "+
c+" WHERE "+m.join(" OR "),l,k,a.fireDB.onError);d+=20};a.fireDB.db.transaction(e)},getMax:function(c,b,f){var l='MAX("'+b+'")',d=function(a,d){var b=0;d.rows&&d.rows.length&&(b=d.rows.item(0)[l]);f(b)};a.fireDB.db.transaction(function(g){g.executeSql("SELECT "+l+' FROM "'+c+'"',[],d,a.fireDB.onError)})},tab:{getItems:function(c,b){var f={},l=[],d=1,g=function(){for(var a in f)f.hasOwnProperty(a)&&l.push(f[a]);0==d&&b&&window.setTimeout(function(){b(l)},1)},m=function(a){for(var b=0;b<a.length;b++)f[a[b]["uso:script"]]=
a[b];0==--d&&g()};y.get.empty(c)||s.each(y.get.urls(c),function(g,b){la.isAllowed(b)&&(d++,a.url.getItems(b,m))});d--;g()},getCountCallbacks:{},resetFireCnt:function(c){a.tab.getCountCallbacks[c]=[];y.set.fire.count(c,null)},getCount:function(c,b){var f=y.get.fire.count(c);f?b(f):(f=function(b){y.set.fire.count(c,b.length);b=b.length;if(a.tab.getCountCallbacks[c])for(;0<a.tab.getCountCallbacks[c].length;){var d=a.tab.getCountCallbacks[c].pop();d&&d(b)}},a.tab.getCountCallbacks[c]||(a.tab.getCountCallbacks[c]=
[]),0==a.tab.getCountCallbacks[c].length&&a.tab.getItems(c,f),a.tab.getCountCallbacks[c].push(b))}},url:{getCount:function(c,b){D&&console.log("bg: TF: get count for URL "+c);var f=function(a,g){var c=0;g.rows&&g.rows.length&&(c=g.rows.item(0)["count(*)"]);b(c)},e="",e=e+"SELECT count(*) FROM scripts WHERE sid IN ",e=e+"    (SELECT sid FROM scriptincludes WHERE iid IN (SELECT iid FROM includes WHERE generic=0 AND ? REGEXP regex)) ",e=e+"AND NOT sid IN ",e=e+"    (SELECT sid FROM scriptexcludes WHERE eid IN (SELECT eid FROM excludes WHERE ? REGEXP regex)) ";
a.fireDB.db.transaction(function(d){d.executeSql(e,[c,c],f,a.fireDB.onError)})},getItems:function(c,b){D&&console.log("bg: TF: get scripts for URL "+c);var f=[],e,d=0,g=0;e="SELECT * FROM scripts T1 WHERE T1.sid IN     (SELECT sid FROM scriptincludes WHERE iid IN (SELECT iid FROM includes WHERE generic=0 AND ? REGEXP regex)) ";e+="AND NOT T1.sid IN ";e+="    (SELECT sid FROM scriptexcludes WHERE eid IN (SELECT eid FROM excludes WHERE ? REGEXP regex)) ";var m="*"==c,k=m?"SELECT DISTINCT t1.value, t1.sid FROM scripts T1 JOIN scriptincludes T2 ON T1.sid=T2.sid WHERE T2.iid IN (SELECT iid FROM includes WHERE generic=0)":
e,h=function(a,c){g=(new Date).getTime();D&&console.log("bg: TF db access: 1 -> "+(g-d)+"ms");if(c.rows&&c.rows.length)for(var k=0;k<c.rows.length;k++)try{var m=c.rows.item(k).value;f.push(JSON.parse(m))}catch(e){console.error("bg: error parsing TamperFire entry ",c.rows.item(k))}else console.warn("bg: warn: no scripts entry");b(f)};a.fireDB.db.transaction(function(g){d=(new Date).getTime();g.executeSql(k,m?[]:[c,c],h,a.fireDB.onError)})}},ids:{getItems:function(c,b){var f=[],e=function(a){if(a&&
a.length)for(var g=0;g<a.length;g++)try{f.push(JSON.parse(a[g]))}catch(c){console.error("bg: error parsing TamperFire entry "+a)}else console.warn("bg: warn: no scripts entry");b(f)};c.length?a.scripts.getValues(c,null,e):b(f)}},includes:{setValues:function(c,b){a.setValues("includes",["regex","generic","iid"],c,b)}},scriptIncludes:{setValues:function(c,b){a.setValues("scriptincludes",["iid","sid"],c,b)}},excludes:{setValues:function(c,b){a.setValues("excludes",["regex","eid"],c,b)}},scriptExcludes:{setValues:function(c,
b){a.setValues("scriptexcludes",["eid","sid"],c,b)}},scripts:{getValues:function(c,b,f){a.getValues("scripts","sid",c,function(a){for(var d=[],g=0;g<a.length;g++)d.push(a[g].value);f(d)})},setValue:function(c,b,f){a.setValue("scripts","sid",c,"value",b,f)},setValues:function(c,b){a.setValues("scripts",["sid","value"],c,b)}}};return a}();fire=F;var Ia=function(){for(var a=[],c=[],b=0;b<a.length;b++){var f=Registry.getRaw("system/"+a[b]+".tamper.js");f&&c.push(f)}return c},J=function(){var a=0,c=[],
b={to:null,force:null,t:0},f={},l=function(a){D&&console.debug("sync: import",a.uuid,a.name,a.url);var d={imported:h.values.sync_type},g={},b;for(b in r.SYNCED)!0===r.SYNCED[b]&&(g[b]=a.options[b]);return u.installFromUrl(a.url,{uuid:a.uuid,ask:!1,internal:!0,sync:d,force_options:g},{silent_fail:!0})},d=function(a){D&&console.debug("sync: export",a.name,a.url);return K.add(a)},g=function(a){var d=a.downloadURL?a.downloadURL.split("#")[0]:null,g=a.fileURL?a.fileURL.split("#")[0]:null,b=s.select([g,
d],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0],d={uuid:a.uuid,name:a.name,options:{},durl:d,furl:g,url:b},c;for(c in r.SYNCED)!0===r.SYNCED[c]&&null!==a.options[c]&&(d.options[c]=a.options[c]);return d},m=function(){var a=[];z.getUidList().forEach(function(d){d=z.getByUid(d);d.script&&d.cond&&a.push(g(d.script))});return a},k=function(g){if(r.enabled)if(0<a)g&&r.addSyncDoneCallback(function(a){a&&r.sync(50,g)});else{a++;var b=null,k=null,x=!0,t={},n=function(a){if(a){(a=a.split("#")[0])&&
(a=a.toLowerCase());for(var d=0;d<b.length;d++){var g=b[d].furl?b[d].furl.toLowerCase():null,c=b[d].durl?b[d].durl.toLowerCase():null;if(g==a||c==a)return b[d]}}return null},p=function(a){if(a)for(var d=0;d<k.length;d++)if(k[d].uuid==a)return k[d];return null},s=function(a){if(a){a=a.split("#")[0];for(var d=0;d<k.length;d++)if(k[d].url==a)return k[d]}return null},y=function(a){if(!a)return null;for(var d=0;d<b.length;d++)if(b[d].uuid==a)return b[d]};(function(){b=m();return K.list().done(function(a){k=
a}).fail(function(){D&&console.error("sync: unable to get remotelist!")})})().then(function(){for(var a=v(),d=[],g=0;g<k.length;g++)d.push(function(){var a=k[g],d=!1,b=!1,c=2==h.values.sync_version?y(a.uuid):n(a.url);if(c)if(d=!0,t[a.url]=!0,a.uuid&&(t[a.uuid]=!0),a.content&&M.MD5(a.content)!=M.MD5(c.textContent))b=!0;else for(var m in r.SYNCED)if(!0===r.SYNCED[m]&&c.options[m]!=a.options[m]){b=!0;break}if(d)if(a.options.removed)D&&console.debug("sync: remove local script",a.uuid,a.name,a.url),u.doRemove(c.uuid,
!1);else if(b)if(D&&console.debug("sync: update local script",a.uuid,a.name,a.url),b=z.getByUid(c.uuid),b.script&&b.cond){for(m in r.SYNCED)!0===r.SYNCED[m]&&(b.script.options[m]=a.options[m]);a.content&&(b.script.textContent=a.content);u.doModify(b.script.uuid,b.script,!1)}else console.log(e.getMessage("fatal_error")+"("+c.name+")!!!");if(!d&&!a.options.removed)if(d=v(),f[a.url]||a.uuid&&f[a.uuid])D&&console.warn("sync: skip previously failed import",a);else return l(a).done(function(d){d||(D&&console.warn("sync: unable to import",
a),f[a.url]=!0,a.uuid&&(f[a.uuid]=!0))}).fail(function(){D&&console.warn("sync: unable to load",a);f[a.url]=!0;a.uuid&&(f[a.uuid]=!0)}).always(d.resolve),d.promise();return w()}());$.when.apply($,d).done(function(){a.resolve()});return a.promise()}).then(function(){b=m();return w()}).then(function(){if(!K.isWritable())return w();for(var a=v(),g=[],c=0;c<b.length;c++)g.push(function(){var a=b[c],g=!1;if(!a.url||t[a.url]||t[a.uuid])return w();if(2==h.values.sync_version?p(a.uuid):s(a.url))g=!0;return g?
w():d(a).done(function(a){})}());$.when.apply($,g).done(function(){a.resolve()});return a.promise()}).fail(function(){x=!1}).done(function(){x=!0}).always(function(){D&&console.debug("sync: finished");if(0==--a)for(var d=x;c.length;)c.shift()(d)})}},x=function(a,d){r.enabled&&r.sync(500,!0)},t=null,r={enabled:!1,SYNCED:{comment:!0},createTeslaData:function(){for(var a=v(),d=[],g=m(),b=0;b<g.length;b++)if(g[b].url){var c=JSON.stringify(g[b].options),c=g[b].name.replace(/\|/g,"!")+"|"+c+"|"+g[b].url.replace(/\|/g,
"%7C");d.push(c)}a.resolve(d);return a.promise()},configChangeListener:function(a,d,g){t||(t=window.setTimeout(function(){t=null;r.init().done(function(){r.enabled&&r.sync(3E3)})},3E3))},init:function(){var a=v();r.enabled=!1;(function(){return h.values.sync_enabled&&h.values.sync_type?K.init(h.values.sync_type,h.values.sync_version,h.values.sync_id).done(function(a){r.enabled=a;r.enabled?K.addChangeListener(x):console.warn("sync: init failed!")}):w()})().always(function(){a.resolve(r.enabled)});
return a.promise()},finalize:function(){},reset:function(){return K.reset()},addSyncDoneCallback:function(a){c.push(a)},sync:function(a,d){var g=(new Date).getTime();a=a||500;d=b.force||d;b.to?(window.clearTimeout(b.to),b.ts<g+a&&(a=b.ts-g,1>a&&(a=1))):D&&console.debug("sync: schedule sync for run in "+a+" ms");b.force=d;b.ts=g+a;b.to=window.setTimeout(function(){k(b.force);b.to=null;b.force=null},a)},scriptAddedCb:function(a,b){if(r.enabled&&K.isWritable()){var c=g(b);c.url&&B.parse(c.url).protocol.match(/https?:/)&&
d(c)}},scriptChangedCb:function(a,b,c){if(r.enabled&&K.isWritable()&&(a=g(b),a.url))for(var k in r.SYNCED)if(!0===r.SYNCED[k]&&b.options[k]!=c.options[k]){d(a);break}},scriptRemovedCb:function(a,d){if(r.enabled&&K.isWritable()){var b=g(d);b.url&&(D&&console.debug("sync: remove",b.name,b.url),K.remove(b))}}};return r}();sycl=J;var Ja=function(a){h.addChangeListener("scriptblocker_overwrite",I.init);h.addChangeListener("sync_enabled",J.configChangeListener);h.addChangeListener("sync_type",J.configChangeListener);
h.addChangeListener("sync_id",J.configChangeListener);h.addChangeListener("sync_version",J.configChangeListener);h.addChangeListener("fire_enabled",function(a,b,f){f&&!F.status.initialized&&F.init()});h.addChangeListener("logLevel",function(){sa(h.values.logLevel)});h.addChangeListener("i18n",function(){e.setLocale(h.values.i18n)});h.addChangeListener("native_import_path",function(){P.setPath(h.values.native_import_path)});h.addChangeListener("incognito_mode",function(){ya()});h.addChangeListener("require_blacklist",
u.blackCheckAll);h.addChangeListener("script_blacklist_server",u.blackCheckAll);h.addChangeListener("script_blacklist_type",u.blackCheckAll);h.addChangeListener("downloads_extension_whitelist",L.config_changed_listener);h.addChangeListener("downloads_mode",L.config_changed_listener)},h=function(){var a;a="// ==UserScript==\n// @name         My Fancy New Userscript\n";a+="// @namespace    http://your.homepage/\n";a+="// @version      0.1\n";a+="// @description  enter something useful\n";a+="// @author       You\n";
a+="// @match        <$URL$>\n";a+="// @grant        none\n";a+="// ==/UserScript==\n\n";var c={},b={enabled:!0,configMode:0,safeUrls:!0,tryToFixUrl:!0,debug:!1,logLevel:0,showFixedSrc:!1,webrequest_modHeaders:"yes",webrequest_fixCSP:"yes",scriptblocker_overwrite:"no",notification_showUpdate:"changelog",notification_silentScriptUpdate:!0,scriptTemplate:a,scriptUpdateCheckPeriod:864E5,scriptUpdateHideNotificationAfter:15E3,scriptUpdateCheckDisabled:!1,runtime_fastDocumentStart:!0,autoReload:!1,appearance_badges:"running",
fire_enabled:!1,fire_sort_cache_enabled:!0,fire_getURL:"http://fire.tampermonkey.net/get.php",fire_updatePeriod:12096E5,fire_topOnly:!0,editor_enabled:!0,editor_keyMap:"windows",editor_indentUnit:4,editor_indentWithTabs:!1,editor_tabMode:"smart",editor_enterMode:"indent",editor_electricChars:!0,editor_autoSave:!1,editor_easySave:!0,native_import:!0,native_import_path:null,native_import_post_action:"disable",i18n:null,incognito_mode:"temporary",layout:"default",sync_enabled:!1,sync_type:2,sync_version:2,
sync_id:"",statistics_enabled:!0,downloads_mode:"default",downloads_extension_whitelist:"/^[^\\.]*$/ /\\.mp[34]$/ .wav /\\.(avi|mkv|flv|divx|mpe?g)$/ /\\.(ico|gif|png|jpe?g)/ .txt .iso .zip /\\.r(ar|[0-9]{2,2})$/".split(" "),require_timeout:2E4,require_blacklist:["/^https?:\\/\\/example.com\\/.*/"],script_blacklist_server:[],script_blacklist_type:"server",script_blacklist_severity:4,page_filter_mode:"black",page_whitelist:["/https?:\\/\\/userscripts\\.org\\/.*/","http://xkcd.com/970/"],forbiddenPages:"*.paypal.tld/* https://*deutsche-bank-24.tld/* https://*bankamerica.tld/* *://apis.google.com/*/+1/*button* *://www.facebook.com/plugins/* *://platform.twitter.com/widgets/*".split(" ")},
f=function(a,g){var m=p.getValue(n.CONSTANTS.STORAGE.CONFIG,{}),k=void 0===m[a]?b[a]:m[a];c[a]&&JSON.stringify(k)!=JSON.stringify(g)&&c[a].forEach(function(b){window.setTimeout(function(){b(a,k,g)},1)});m[a]=g;p.setValue(n.CONSTANTS.STORAGE.CONFIG,m)},e={init:function(){var a=v();e.values={};for(var g in b)b.hasOwnProperty(g)&&function(){var a=g;e.values.__defineGetter__(a,function(){var d=p.getValue(n.CONSTANTS.STORAGE.CONFIG,{});return void 0===d[a]?b[a]:d[a]});e.values.__defineSetter__(a,function(d){f(a,
d)})}();e.images={};e.images.icon="images/icon.png";e.initialized=!0;var c=Ia(),k;for(k in c){var h=c[k];window.setTimeout(function(){u.doSave({url:null,src:h,ask:!1,replace:!0,internal:!0})},1)}a.resolve();return a.promise()},addChangeListener:function(a,g){c[a]||(c[a]=[]);c[a].push(g)}};return e}(),V=function(a,c){return ga(a,c,{internal:!0})},T=function(){var a={key:function(a,d){return n.CONSTANTS.PREFIX.EXTERNAL+s.select([a,d?M.MD5(d):null],function(a){return a}).join(":")},list:function(a){var d=
RegExp("^"+a);return s.select(p.listValues(),function(a){return-1!=a.search(d)})},set:function(d,b,c){d=a.key(d,b);var f={};s.each(c,function(a,d){"content"==d&&(d="base",a=M.encodeS(a));f[d]=a});p.setValue(d,{ts:(new Date).getTime(),url:b,resource:f})},get:function(d,b){var c=a.key(d,b),c=p.getValue(c),f;if(c&&c.resource){var e={};s.each(c.resource,function(a,d){"base"==d&&(d="content",a=M.decodeS(a));e[d]=a});f={ts:c.ts,url:c.url,data:e}}return f},clean:function(d,b){var c=a.key(d,b);p.deleteValue(c)},
cleanAll:function(d,b){var c,f=a.list(a.key(d));if(b){var e={};s.each(b,function(b){b=a.key(d,b);e[b]=!0});c=[];s.each(f,function(a){e[a]||c.push(a)})}else c=f;c.forEach(function(a){p.deleteValue(a)})}},c=function(a,d){var b=v(),c={method:"GET",url:a,retries:n.XMLHTTPREQUEST.RETRIES,responseType:d.via_arraybuffer?"arraybuffer":void 0},f=function(c){var f={content:""};if(4!=c.readyState||200!=c.status&&0!=c.status)b.reject(f);else{var e,l=c.responseHeaders?c.responseHeaders.split("\n"):null,h;for(h in l){var x=
l[h].split(":"),r=x.shift()||"",x=x.join(":")||"";if("content-type"==r.trim().toLowerCase()&&-1!=x.search("image")){e=x.trim();break}}e||(-1!=a.search(".ico$")||-1!=a.search(".jpg$")?e="image/x-icon":-1!=a.search(".gif$")?e="image/gif":-1!=a.search(".png$")?e="image/png":s.isLocalImage(a)&&(e="image/x-icon"));f.meta=e;f.content=d.via_arraybuffer?M.arrbuf2str(c.response):c.responseText;b.resolve(f)}},e=function(a){b.reject({})};d.sync?f(V(c,{})):(c.timeout=h.values.require_timeout,V(c,{onload:f,onerror:e,
ontimeout:e}));return b.promise()},b=s.getDebouncer(9E3),f=function(d,b,c){c.no_storage=!0;e(d,b,c).done(function(c){a.set(d,b,c.resource)}).fail(function(a){}).always(function(c){(c=a.get(d,b))&&c.data?a.set(d,b,c.data):console.warn("externals: should never happen!")})},e=function(d,m,k){var e=v(),l=B.parse(m),r={sync:k.sync},q;if(m)if(da.getEvilnessOf(m)>=h.values.script_blacklist_severity)r.resource={blacklisted:!0,content:""},e.reject(r);else if(!k.no_storage&&"file:"!==l.protocol&&(q=a.get(d,
m))){var fa=a.key(d,m),H=(new Date).getTime();2592E5<H-q.ts&&!b.is(fa)&&(b.add(fa),D&&console.log("externals: resource needs update",m,(new Date(q.ts)).toISOString(),(new Date(H)).toISOString()),window.setTimeout(function(){f(d,m,k)},3E3));r.resource=q.data;e.resolve(r)}else r.sync=!1,"file:"==l.protocol?(n.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||console.warn("externals: Access to local files is forbidden! Loading the following @resource may fail:",m,"-> more info:","http://tampermonkey.net/faq.php#Q204"),
q=xa.getSource({url:m,encoding:k.encoding})):q=c(m,{via_arraybuffer:k.via_arraybuffer}),q.done(function(b){k.no_storage||"file:"===l.protocol||a.set(d,m,b);r.resource=b;e.resolve(r)}).fail(function(a){D&&console.log("externals: get.failed",d,m,a);r.resource={failed:!0,content:""};e.reject(r)});else r.resource={forbidden:!0,content:""},e.reject(r);return e.promise()},d={getElement:function(d,b){return a.get(d,b)},cleanElement:function(d,b){return a.clean(d,b)},dropAll:function(d){a.cleanAll(d);return w()},
dropAllBut:function(d,b){a.cleanAll(d,b);return w()},loadResources:function(a,b){var c=v();d.getResources(a,b).always(function(){c.resolve()});return c.promise()},loadRequires:function(a,b){var c=v();d.getRequires(a,b).always(function(){c.resolve()});return c.promise()},getResources:function(a,d){var b={elements:[]},c=v(),f=[],h={via_arraybuffer:!0,sync:!0};d.forEach(function(d){var c={name:d.name},m=e(a,d.url,h),x=v();m.done(function(a){a=a.resource;var b=[d.url,a.content.length].join(),g=X.items.resources.get(b)||
{};try{c.resText=g.resText?g.resText:M.UTF8.decode(a.content)}catch(k){c.resText=""}try{c.resURL=g.resUrl?g.resURL:a.meta?"data:"+a.meta+";base64,"+M.Base64.encode(a.content):M.Base64.encode(a.content)}catch(f){c.resURL=d.url}X.items.resources.set(b,{resText:c.resText,resURL:c.resURL})}).fail(function(a){a.resource&&a.resource.forbidden?console.warn("externals: can't load @resource",d.name,"from forbidden URL",d.unsafe_url):a.resource&&a.resource.blacklisted?console.warn("externals: can't load @resource",
d.name,"from blacklisted URL",d.unsafe_url):console.warn("externals: can't load @resource",d.name,"from URL",d.unsafe_url);c.resText="";c.resURL=""}).always(function(a){h.sync&=a.sync;b.elements.push(c);x.resolve()});f.push(x)});$.when.apply($,f).always(function(){c.resolve(b)});return c.promise()},getRequires:function(a,d){var b={elements:[]},c=v(),f=[],h={encoding:"UTF-8",sync:!0};s.each(d,function(d,c){var m={},x=e(a,d.url,h),n=v();x.done(function(a){m.textContent=a.resource.content||""}).fail(function(a){a.resource&&
a.resource.forbidden?(m.textContent='// this @require ("'+encodeURIComponent(d.unsafe_url)+'") is not allowed!\n',console.warn("externals: can't load @require from forbidden URL",d.unsafe_url)):a.resource&&a.resource.blacklisted?(m.textContent='// this @require ("'+encodeURIComponent(d.unsafe_url)+'") is blacklisted!\n',console.warn("externals: can't load @require from blacklisted URL",d.unsafe_url)):(m.textContent='// this @require ("'+encodeURIComponent(d.unsafe_url)+'") could not be loaded!\n',
console.warn("externals: can't load @require from URL",d.unsafe_url))}).always(function(a){h.sync&=a.sync;b.elements[c]=m;n.resolve()});f.push(n)});$.when.apply($,f).always(function(){b.elements=b.elements.filter(function(a){return a});c.resolve(b)});return c.promise()}};return d}();exts=T;var Ha=function(){var a=function(a,b,f){var e=v(),d=[];f.forEach(function(b){b=b.textContent||"";b=ma.mkCompat(b,a.options.compatopts_for_requires?a:null,!1);d.push(b)});f="\n"+d.join("\n")+"\n";var g=z.getStorageByUid(a.uuid);
b=ma.mkCompat(b,a,!1);h.values.debug&&(b="debugger;\n"+b);b={method:"executeScript",header:a.header,code:b,requires:f,version:chrome.extension.getVersion(),storage:g,script:a};e.resolve(b);return e.promise()};return{inject:function(c,b,f){var e={},d;for(d in b)"includes"!=d&&"matches"!=d&&"requires"!=d&&"resources"!=d&&"excludes"!=d&&"textContent"!=d&&("options"==d?(e[d]=JSON.parse(JSON.stringify(b[d])),e[d].run_at=e[d].run_at||b.options.override.orig_run_at||"document-end"):e[d]=b[d]);return T.getResources(e.uuid,
b.resources).then(function(a){f&&!a.sync&&(D&&console.warn("ri: uncached @external detected -> fast script start disabled"),f=a.sync);e.resources=a.elements;return T.getRequires(e.uuid,b.requires)}).then(function(d){f&&!d.sync&&(D&&console.warn("ri: uncached @external detected -> fast script start disabled"),f=d.sync);d=d.elements;console.log("run script "+e.name+" @ "+c.url);return a(e,b.textContent,d)}).then(function(a){var d=v();a.id=c.contextId;chrome.tabs.sendMessage(c.tabId,a,d.resolve);return d.promise()})}}}(),
za=function(a){a&&(a+=(-1==a.search("\\?")?"?":"&")+"ts="+(new Date).getTime());return a},Aa=function(){var a=chrome.extension.getViews({type:"popup"});a&&a.length&&chrome.extension.sendMessage({method:"updateActions"},function(a){})},S=function(){return{getConfig:function(){var a={db_version:0,last:0,entries:0},c={version:0,last:0},b={scripts:0,fire:a},f=p.getValue(n.CONSTANTS.STORAGE.UPDATE,b);"object"!==typeof f&&(f=b);f||(f=b);void 0==f.fire&&(f.fire=a);void 0==f.black&&(f.black=c);void 0==f.scripts&&
(f.scripts=0);return f},setConfig:function(a){a&&p.setValue(n.CONSTANTS.STORAGE.UPDATE,a)}}}(),aa={check:function(a,c,b,f){if(a||0!=h.values.scriptUpdateCheckPeriod){var l=function(a){if(c){a=e.getMessage("Script_Update");var g=e.getMessage("Check_for_userscripts_updates")+"...";N.show(a,g,chrome.extension.getURL("images/icon128.png"),1E4)}console.log("update: check for script updates "+(b?" for "+b:""));aa.updateUserscripts(0,c,b,function(a,d){if(a)try{var g=b||d.uuid,c=function(a){a.clicked&&u.doSave({url:d.url,
uuid:g,replace:!g,src:d.code,ask:!h.values.notification_silentScriptUpdate,hash:d.newhash})},l=e.getMessage("There_is_an_update_for_0name0_avaiable_",d.name)+"\n"+e.getMessage("Click_here_to_install_it_"),q=e.getMessage("Just_another_service_provided_by_your_friendly_script_updater_")+":";h.values.notification_silentScriptUpdate?c({clicked:!0}):N.show(q,l,chrome.extension.getURL("images/icon128.png"),h.values.scriptUpdateHideNotificationAfter,c)}catch(n){console.error("update: notification error "+
n.message)}f&&f(a)})};(function(){var d=S.getConfig();if(a||(new Date).getTime()-d.scripts>h.values.scriptUpdateCheckPeriod){var b=function(){m&&(window.clearTimeout(m),m=null);k&&k.cancel();l();d=S.getConfig();d.scripts=(new Date).getTime();S.setConfig(d)},m,k,x=function(){k=null;var a=e.getMessage("Script_Update"),d=e.getMessage("Waiting_for_sync_to_finish")+"...";k=N.show(a,d,chrome.extension.getURL("images/icon128.png"),6E4)};J.enabled?(J.addSyncDoneCallback(b),J.sync(50,!1),c&&(m=window.setTimeout(x,
500))):b()}else f&&(console.warn("update: check -> no force but callback"),window.setTimeout(f,1))})();window.setTimeout(aa.check,3E5)}},srcCmp:function(a,c){var b=Y.createScriptFromSrc(c);if(!b.name||""==b.name||void 0===b.version)return-2;var f=z.getMetaByUid(a);return f&&f.system?null:b.options.compat_uW_gmonkey?-2:-1!=b.name.search("@")?-2:f&&b.version==f.version?0:f&&-1==R(b.version,f.version)?-1:1},updateUserscripts:function(a,c,b,f){var l=1,d=0,g=function(){0==--l&&0==d&&(c&&(D&&console.debug("No update found"),
N.show("Narf!",e.getMessage("No_update_found__sry_"),chrome.extension.getURL("images/icon128.png"),1E4)),f&&window.setTimeout(f,1))},m=function(a){var b={method:"GET",retries:n.XMLHTTPREQUEST.RETRIES,timeout:1E3*n.SCRIPT_DOWNLOAD.TIMEOUT,url:u.determineSourceURL(a.script,!0)};l++;(function(){var c=u.determineSourceURL(a.script);ga(b,{ondone:function(b){if(4==b.readyState&&200==b.status){var k=aa.srcCmp(a.script.uuid,b.responseText);if(1==k||a.hash_different){d++;f&&f(!0,{name:a.script.name,url:c,
uuid:a.script.uuid,code:b.responseText,newhash:a.meta?a.meta["uso:hash"]:null});return}0==k&&a.meta&&(a.script.hash=a.meta["uso:hash"],u.doModify(a.script.uuid,a.script,!1))}else console.log(e.getMessage("UpdateCheck_of_0name0_Url_0url0_failed_",[a.script.name,c]));g()}})})()},k=function(a,d){var b=u.determineMetaURL(a,!0);b?ga({method:"GET",retries:n.XMLHTTPREQUEST.RETRIES,timeout:1E3*n.SCRIPT_DOWNLOAD.TIMEOUT,headers:{Accept:"text/x-userscript-meta"},url:b},{ondone:function(g){a.meta=null;if(4==
g.readyState&&200==g.status){var c=Y.processMetaHeader(g.responseText);a.meta=c;a.metasrc=g.responseText}else console.log("update: unable to find meta data @ "+b+" req.status = "+g.status);d(a)}}):(a.meta=null,d(a))},x=function(a){l++;k(a.script,function(d){var b=!!d.meta,c=b&&!!d.meta.version,f=c&&(!a.script.version||1==R(d.meta.version,a.script.version)),k=b&&(a.script.hash||!c)&&!!d.meta["uso:hash"]&&d.meta["uso:hash"]!=a.script.hash;if(!b||k||!c||f)a.meta=d.meta,a.metasrc=d.metasrc,a.hash_different=
k,m(a);g()})},t=!1;z.getUidList().forEach(function(a){var d=z.getByUid(a);d.script&&d.cond?(a=!h.values.scriptUpdateCheckDisabled&&!d.script.enabled&&!b,b&&d.script.uuid!==b||a||!u.determineSourceURL(d.script)||(t=!0,x(d))):console.warn("update: inconsistent script entry",a,d)});!t&&b&&f&&window.setTimeout(f,1);g()}};trup=aa;var u=function(){var a=function(a){a.sort(function(a,d){return a.position-d.position});return a},c=function(a){void 0===a.ask&&(a.ask=!0);if(void 0===a.url||null==a.url)a.url=
"";void 0===a.hash&&(a.hash="");""===a.force_url&&(a.force_url=null);var b=Y.createScriptFromSrc(a.src),c,f={heading:null,errors:[],info:[],warnings:[],flags:{}},x=v(),t=(new Date).getTime(),n=a.save&&!a.ask&&h.values.editor_easySave,q=a.uuid,p;b.name&&void 0!=b.version?p=w():(f.errors.push(e.getMessage("Invalid_UserScript__Sry_")+"\n\n"),a.name&&f.errors.push(e.getMessage("Script_name_0url0",a.name)+"\n\n"),a.url&&f.errors.push(e.getMessage("Downloaded_from_0url0",a.url)),console.warn("scriptman: invalid userscript",
f,b),p=O());p.then(function(){a.replace&&!q&&(q=z.getUidsByName(b.name,b.namespace)[0]);c=q?z.getMetaByUid(q):null;if(!q)if(a.replace)q=s.createUUID();else return console.error("scriptman: neither UUID nor replace option set"),O();return""!==q.replace(/[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}/,"")?(console.error("scriptman: invalid UUID",q),O()):!a.clean&&!a.defaultscript&&c&&c.system?O():w()}).then(function(){return a.clean&&a.name&&a.name!=b.name||-1!=b.name.search("\n")?
(f.errors.push(e.getMessage("Invalid_UserScript_name__Sry_")),O()):w()}).then(function(){return b.options.compat_uW_gmonkey?(f.errors.push(e.getMessage("This_script_uses_uW_gm_api_")),O()):w()}).then(function(){if(c){c.name!=b.name&&(f.flags.renamed=!0);if(c.lastModified&&void 0!==a.lastModified&&c.lastModified!==a.lastModified){var l=e.getMessage("some_secs");try{var h=Math.max(1,Math.floor((t-c.lastModified)/1E3));isNaN(h)||(l=h)}catch(x){}f.warnings.push(e.getMessage("CONFLICT__This_script_was_modified_0t0_seconds_ago_",
l));f.flags.forceAsk=!0}f.flags.hashChanged=a.hash&&c.hash!=a.hash;b.version!=c.version||f.flags.hashChanged||(a.save?f.flags.modification=!0:f.flags.reset=!0);a.clean&&(f.flags.factory=!0)}else f.flags.first_install=!0;b.includes.length||b.matches.length||(l="/"+B.staticVars.urlAllHttp_+"/",n||a.internal||f.warnings.push(e.getMessage("This_script_does_not_provide_any__include_information_")+"\n"+e.getMessage("Tampermonkey_assumes_0urlAllHttp0_in_order_to_continue_",l)),b.includes.push(l));f.flags.sync=
!!a.sync;f.flags.internal=a.internal;f.flags.ask=a.ask;return w()}).then(function(){b.uuid=q;b.hash=a.hash;b.lastUpdated=t;b.system=a.defaultscript;b.evilness=u.getEvilness(b);b.position=u.determineLastPosition()+1;f.flags.factory||f.flags.reset||(a.force_url&&(b.updateURL=null,b.downloadURL=a.force_url),c&&(b.options.override=c.options.override,b.options.comment=c.options.comment));b.options.override.orig_includes=b.includes;b.options.override.orig_excludes=b.excludes;b.options.override.orig_matches=
b.matches;b=u.mergeCludes(b);b.options.override.orig_noframes=b.options.noframes;b.options.override.orig_run_at=b.options.run_at||"document-end";b.options.noframes=null;b.options.run_at=null;return w()}).then(function(){if(c&&(b.fileURL=c.fileURL,b.hash=c.hash,b.position=c.position,c.sync&&(b.sync=c.sync),!f.flags.factory&&!f.flags.reset)){b.enabled=c.enabled;b.options.noframes=c.options.noframes;b.options.run_at=c.options.run_at;b.options.awareOfChrome||(b.options.compat_forvarin=c.options.compat_forvarin);
a.save&&!a.force_url&&(b.downloadURL=c.downloadURL||b.downloadURL);var h=l.determineMetaURL(c),x=l.determineMetaURL(b);h==x||n||a.internal||f.warnings.push(e.getMessage("The_update_url_has_changed_from_0oldurl0_to__0newurl0",[h,x]))}return w()}).then(function(){return!c||f.flags.factory||b.version!=c.version||f.flags.hashChanged||!a.defaultscript&&!a.noreinstall?w():O()}).then(function(){c?(f.flags.factory||f.flags.reset?(f.flags.reset?(f.heading=e.getMessage("You_are_about_to_reinstall_a_UserScript_"),
f.flags.reinstall=!0):(f.heading=e.getMessage("You_are_about_to_install_a_UserScript_"),f.flags.install=!0),a.internal||f.warnings.splice(0,0,e.getMessage("All_script_settings_will_be_reset_"))):f.flags.modification?f.heading=e.getMessage("You_are_about_to_modify_a_UserScript_"):-1==R(b.version,c.version)?(f.heading=e.getMessage("You_are_about_to_downgrade_a_UserScript"),f.flags.downgrade=!0,n||a.internal||f.warnings.splice(0,0,e.getMessage("The_downgraded_script_might_have_problems_to_read_its_stored_data_"))):
(f.heading=e.getMessage("You_are_about_to_update_a_UserScript_"),f.flags.update=!0),f.info.push({label:e.getMessage("Installed_Version_"),value:"v"+c.version})):(f.heading=e.getMessage("You_are_about_to_install_a_UserScript_"),n||a.internal||f.warnings.splice(0,0,e.getMessage("Malicious_scripts_can_violate_your_privacy_")),f.flags.install=!0);f.flags.install?f.action=e.getMessage("Install"):f.flags.reinstall?f.action=e.getMessage("Reinstall"):f.flags.modification?f.action=e.getMessage("Modify"):f.flags.downgrade?
f.action=e.getMessage("Downgrade"):f.flags.update&&(f.action=e.getMessage("Update"));return w()}).then(function(){a.url&&(b.fileURL=a.url);a.sync&&(b.sync=a.sync);a.force_options&&s.copy(a.force_options,b.options,(new Y.Script).options,!0);a.force_settings&&s.copy(a.force_settings,b,["enabled","position"]);return w()}).then(function(){var a=!1,d;for(d in b.options)if(-1!=d.search("compat_")&&!0===b.options[d]){a=!0;break}a&&f.info.push({label:e.getMessage("Note"),value:e.getMessage("A_recheck_of_the_GreaseMonkey_FF_compatibility_options_may_be_required_in_order_to_run_this_script_")});
return w()}).then(function(){["requires","resources"].forEach(function(a){b[a]=s.map(b[a],function(a){a.unsafe_url=a.url;a.url=B.sanitize(a.unsafe_url,b.fileURL);return a})});return w()}).done(function(){x.resolve({script:b,messages:f,short_info:[{label:e.getMessage("Author"),prop:"author"},{label:e.getMessage("Description"),prop:"description"},{label:e.getMessage("Source"),prop:"fileURL"}]})}).fail(function(){x.reject({messages:f})});return x.promise()},b=function(a){var b=v(),c=a.messages,f=a.script,
e=c.flags.sync&&c.flags.internal,h=function(){var a=l.doModify(f.uuid,f,!e)||{};(c.flags.first_install||c.flags.factory)&&z.setStorageByUid(f.uuid,{ts:(new Date).getTime()});return a},n={},q={lastModified:n.lastModified,installed:!0,renamed:c.flags.renamed};c.warnings.length||c.flags.ask?ka.install(a).done(function(a){a.ok&&(n=h());q.installed=a.ok;q.aborted=a.aborted;b.resolve(q)}).fail(function(a){b.reject(a)}):(n=h(),b.resolve(q));return b.promise()},f=s.getDebouncer(1E3),l={determineSourceURL:function(a,
b){if(!a)return null;var c=s.select([a.downloadURL,a.fileURL],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0];return c&&b?za(c):c},determineMetaURL:function(a,b){if(!a)return null;var c;a.fileURL&&(c=a.fileURL.replace(".user.js",".meta.js"),a.fileURL==c&&(c=a.fileURL.replace(".tamper.js",".meta.js")),a.fileURL==c&&(c=null));return(c=s.select([a.updateURL,a.downloadURL,c],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0])&&b?za(c):c},mergeCludes:function(a){var b,c,f=a.options.override;
a.includes=f.merge_includes&&f.orig_includes?f.orig_includes.slice():[];a.excludes=f.merge_excludes&&f.orig_excludes?f.orig_excludes.slice():[];a.matches=f.merge_matches&&f.orig_matches?f.orig_matches.slice():[];for(b=0;b<f.use_includes.length;b++)c=a.excludes.indexOf(f.use_includes[b]),0<=c&&a.excludes.splice(c,1),a.includes.push(f.use_includes[b]);if("undefined"!==typeof f.use_matches)for(b=0;b<f.use_matches.length;b++)c=a.excludes.indexOf(f.use_matches[b]),0<=c&&a.excludes.splice(c,1),a.matches.push(f.use_matches[b]);
for(b=0;b<f.use_excludes.length;b++)a.excludes.push(f.use_excludes[b]);return a},doSave:function(a){return c(a).then(b)},doRemove:function(a,b){z.removeByUid(a,b);z.setStorageByUid(a,null);T.dropAll(a);return w()},doModify:function(a,b,c){void 0===c&&(c=!0);z.setByUid(a,b,c);return c?T.loadResources(a,b.resources).then(function(){return T.loadRequires(a,b.requires)}).then(function(){return T.dropAllBut(a,s.map([].concat(b.resources).concat(b.requires),function(a){return a.url}))}):w()},exportToJson:function(a,
b){var c=v(),f=u.determineScriptsToRun(null);a&&(f=s.select(f,function(b,c){return a[b.uuid]}));f=na(f,!0);b&&!b.storage||f.forEach(function(a){a.storage=z.getStorageByUid(a.uuid)});c.resolve({scripts:f});return c.promise()},importFromJson:function(a){if(!a||!a.scripts||!a.scripts.length)return O();for(var g=v(),f={},e=[],l={},h=0,n;n=a.scripts[h];h++)try{var q=v();"new-user-script"!=n.uuid&&(n.storage&&(l[n.uuid]=n.storage),c({uuid:n.uuid,name:n.name,src:n.source,force_settings:{enabled:n.enabled,
position:n.position},force_options:n.options,replace:!0,url:n.file_url||n.update_url,ask:!1}).done(function(a){f[s.createUUID()]=a;q.resolve()}).fail(function(a){console.warn("import: Error @ script",n.name,a);q.resolve()}),e.push(q.promise()))}catch(p){console.log("import: Error while importing script",n.name,p)}$.when.apply($,e).always(function(){ka.import(f).done(function(a){var d=[];if(a.ok)for(var c=0,e;e=a.import_ids[c];c++)(function(){var a=e;if(f[a]){f[a].messages.warnings=[];var c=b(f[a]).done(function(){var d;
(d=f[a].script.uuid)&&l[d]&&z.setStorageByUid(d,{data:l[d].data||{},ts:(new Date).getTime()})});d.push(c)}})();$.when.apply($,d).always(function(){u.reorderScripts();g.resolve()})}).fail(function(a){g.reject(a)})});return g.promise()},installFromUrl:function(a,b,c){var k=v(),h=B.parse(a);b=b||{};c=c||{};var t=[a,JSON.stringify(b)].join("_");if(f.is(t))return D&&console.log("scriptman: de-bounced installFromUrl",a),O();f.add(t);if(!h.protocol.match(/(https?|file):/))return console.warn("scriptman: can't install from ",
a),O();"file:"!=h.protocol||n.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||console.warn("scriptman: Access to local files is forbidden! Loading the following script for installation may fail:",a,"-> more info:","http://tampermonkey.net/faq.php#Q204");var p=function(b,g){if(!b)if(g)b={messages:{errors:[e.getMessage("Unable_to_load_script_from_url_0url0",a)],warnings:[]}},"file:"!=h.protocol||n.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||b.messages.warnings.unshift(e.getMessage("Tampermonkey_has_no_file_access_permission_"));
else{k.reject();return}b.heading=e.getMessage("You_are_about_to_install_a_UserScript_");c.silent_fail?k.reject(b):ka.installError(b).always(function(a){k.reject(a)})},t=function(a){p(null,a)};V({method:"GET",retries:n.XMLHTTPREQUEST.RETRIES,timeout:1E3*n.SCRIPT_DOWNLOAD.TIMEOUT,url:a},{onload:function(c){if(4==c.readyState)if(200==c.status||0==c.status){var f={url:a,src:c.responseText,ask:!0,replace:!0};b&&s.each(b,function(a,d){f[d]=b[d]});l.doSave(f).done(function(a){k.resolve(a.installed)}).fail(p)}else k.reject()},
onerror:t,ontimeout:t});return k.promise()},determineLastPosition:function(){var a=0;z.getUidList().forEach(function(b){var c=z.getByUid(b);c.script&&c.cond?c.script.position&&c.script.position>a&&(a=c.script.position):console.warn("scriptman: inconsistent script entry",b)});var b=new Y.Script;b.position>a&&(a=b.position);return a},matchUrl:function(a,b,c){var f,e;try{!c&&1<b.length&&"/"==b.substr(0,1)?f=RegExp(".*"+b.replace(/^\//g,"").replace(/\/$/g,"")+".*","i"):c?(e=B.getRegExpFromMatch(b),f=
RegExp(e)):(e=B.getRegExpFromInclude(b,{tryToFixUrl:h.values.tryToFixUrl,safeUrls:h.values.safeUrls}),f=RegExp(e,"i"))}catch(l){return console.warn("scriptman: invalid regexp ",b),!1}return""===a.replace(f,"")},validUrl:function(a,b,c){var f,e=!1;if(b.inc||b.match){for(f in b.inc)if("string"!==typeof b.inc[f])console.warn("scriptman: include["+f+"] '"+b.inc[f]+"' "+(c?"@"+c+" ":"")+"can't be compared to '"+a+"'");else if(l.matchUrl(a,b.inc[f])){D&&console.log("scriptman: @include '"+b.inc[f]+"' matched"+
(c?" ("+c+")":""));e=!0;break}if(b.match)for(f in b.match)if("string"!==typeof b.match[f])console.warn("scriptman: match["+f+"] '"+b.match[f]+"' "+(c?"@"+c+" ":"")+"can't be compared to '"+a+"'");else if(l.matchUrl(a,b.match[f],!0)){D&&console.log("scriptman: @match '"+b.match[f]+"' matched"+(c?" ("+c+")":""));e=!0;break}if(!e)return e}else e=!0;for(f in b.exc)if(l.matchUrl(a,b.exc[f])){D&&console.log("scriptman: @exclude '"+b.exc[f]+"' matched"+(c?" ("+c+")":""));e=!1;break}return e},getEvilness:function(a){var b=
0;return a.fileURL&&(b=da.getEvilnessOf(a.fileURL))||a.downloadURL&&(b=da.getEvilnessOf(a.downloadURL))||a.updateURL&&(b=da.getEvilnessOf(a.updateURL))?(D&&console.log("scriptman: found blacklisted script",a),b):0},blackCheckAll:function(){z.getUidList().forEach(function(a){var b=z.getByUid(a);if(b.script&&b.cond){var c=u.getEvilness(b.script);if(c!==b.script.evilness){if(c||void 0!==b.script.evilness)D&&console.log("scriptman: write blacklist state of ",b.script.name,c),c&&h.values.statistics_enabled&&
Z.tS(b.script.name,c,"b");b.script.evilness=c;l.doModify(a,b.script,!1)}}})},reorderScripts:function(b,c){var f=l.determineScriptsToRun();if(b)for(var e=0;e<f.length;e++){var h=f[e];h.uuid==b&&(h.position=Number(c)+(h.position<c?0.5:-0.5))}for(var f=a(f),n=1,e=0;e<f.length;e++)h=f[e],h.position=n++,l.doModify(h.uuid,h,!1)},getUniqueScriptsForTab:function(a){var b=[];y.get.empty(a.id)?console.warn("bg: WARN: Tabs.get.urls["+a.id+"] is empty!"):s.each(y.get.urls(a.id),function(a,d){if(la.isAllowed(d))for(var c=
u.determineScriptsToRun(d),f=0;f<c.length;f++){for(var e=!1,l=0;l<b.length;l++)if(b[l].uuid==c[f].uuid){e=!0;break}e||b.push(c[f])}});return b},determineScriptsToRun:function(b){var c=[];D&&console.log("scriptman: determineScriptsToRun @"+b);z.getUidList().forEach(function(a){if(b){var f=p.getValue(n.CONSTANTS.PREFIX.COND+a,null);if(!f||!l.validUrl(b,f,a))return}f=z.getByUid(a);f.script&&f.cond?c.push(f.script):console.warn("scriptman: inconsistent script entry",a,f)});return a(c)},determineOrigin:function(a){if(a=
a.fileURL||a.downloadURL||a.updateURL){var b=a.match(/https?:\/\/userscripts\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/);if(b&&3==b.length)return{id:b[2],token:"uso",url:"http://userscripts.org/scripts/show/"+b[2],issue_url:"http://userscripts.org/scripts/issues/"+b[2]};if((b=a.match(/https?:\/\/greasyfork\.org\/scripts\/([^/]+)\/code\/.*\.user\.js/))&&2==b.length)return{id:b[1],token:"gf",url:"https://greasyfork.org/scripts/"+b[1],issue_url:"https://greasyfork.org/scripts/"+b[1]+"/feedback"};
if((b=a.match(/https?:\/\/openuserjs\.org\/install\/([^/]+)+\/(.*)\.user\.js/))&&3==b.length)return b.shift(),{id:b.join("/"),token:"ouj",url:"https://openuserjs.org/scripts/"+b[0]+"/"+b[1],issue_url:"https://openuserjs.org/scripts/"+b[0]+"/"+b[1]+"/issues"};if((a=a.match(/https?:\/\/monkeyguts\.com\/(codepages\/)?([0-9]{1,9})\.user\.js/))&&3==a.length)return{id:a[2],token:"mog",url:"https://monkeyguts.com/code.php?id="+a[2],issue_url:"https://monkeyguts.com/code.php?nav=rev&id="+a[2]}}}};return l}(),
z=function(){var a=[],c={init:function(){p.addDifferentOriginChangeListener(n.CONSTANTS.PREFIX.STORE,function(a,f){if(f&&f.hasOwnProperty("value")&&f.origin){var e=a.replace(n.CONSTANTS.PREFIX.STORE,""),d;for(d in f.value.data)f.value.data.hasOwnProperty(d)&&function(){var a=d,b=f.value.data[d];c.notifyStorageListeners({uuid:e},null,function(d){var c={data:{},ts:0};c.data[a]=b;c.ts=f.value.data.ts;var e={storage:c};void 0===c.data[a]&&(e.removed=a);d(e)})}()}})},getUidList:function(){var a=RegExp("^"+
n.CONSTANTS.PREFIX.SCRIPT_UID),c=[];p.listValues().forEach(function(e){-1!=e.search(a)&&c.push(e.replace(a,""))});return c},getUidsByName:function(a,f){var e=[];c.getUidList().forEach(function(d){var g=c.getMetaByUid(d);!g||g.name!=a||f&&f!=g.namespace||e.push(d)});return e},getUidByName:function(a){console.warn("sb: deprecated fn");return c.getUidsByName(a)[0]},getStorageByUid:function(a){a=p.getValue(n.CONSTANTS.PREFIX.STORE+a,{ts:0,data:{}});"undefined"===typeof a.ts&&(a.ts=0);"undefined"===typeof a.data&&
(a.data={});return a},setStorageByUid:function(a,c){c?p.setValue(n.CONSTANTS.PREFIX.STORE+a,c):p.deleteValue(n.CONSTANTS.PREFIX.STORE+a)},getMetaByUid:function(a){return p.getValue(n.CONSTANTS.PREFIX.META+a,null)},getByUid:function(a){if(!a)return console.error("sb: no UUID set"),{};var c,e=p.getValue(n.CONSTANTS.PREFIX.META+a,null);if(e){var d=function(a){if(a)for(var b=0,d=null;d=a[b];b++)delete d.loaded,delete d.textContent,delete d.resURL,delete d.resText};d(e.requires);d(e.resources);e.uuid=
a;e.textContent=p.getValue(n.CONSTANTS.PREFIX.SCRIPT+a,e.textContent);e.textContent&&(c=e)}return{script:c,cond:p.getValue(n.CONSTANTS.PREFIX.COND+a,null)}},setByUid:function(a,c,e){var d={};if(!a)return console.error("sb: no UUID set",c),d;var g=p.getValue(n.CONSTANTS.PREFIX.META+a),m=!g;p.setValue(n.CONSTANTS.PREFIX.SCRIPT_UID+a,c.name);p.setValue(n.CONSTANTS.PREFIX.COND+a,{inc:c.includes,match:c.matches,exc:c.excludes});p.setValue(n.CONSTANTS.PREFIX.SCRIPT+a,c.textContent);c.textContent=null;e&&
(d.lastModified=(new Date).getTime(),c.lastModified=d.lastModified);p.setValue(n.CONSTANTS.PREFIX.META+a,c);e&&(m?J.scriptAddedCb(c.name,c):J.scriptChangedCb(c.name,c,g),h.values&&h.values.statistics_enabled&&Z.tS(c.name,c.fileURL,m?"i":"u"));X.items.rundata.removeAll();return d},removeByUid:function(a,f){void 0===f&&(f=!0);var e=c.getByUid(a);p.deleteValue(n.CONSTANTS.PREFIX.SCRIPT_UID+a);p.deleteValue(n.CONSTANTS.PREFIX.COND+a);p.deleteValue(n.CONSTANTS.PREFIX.SCRIPT+a);p.deleteValue(n.CONSTANTS.PREFIX.META+
a);p.deleteValue(n.CONSTANTS.PREFIX.STORE+a);f&&(e.script&&e.cond&&J.scriptRemovedCb(e.script.name,e.script),h.values&&h.values.statistics_enabled&&Z.tS(e.script.name,null,"r"));X.items.rundata.removeAll();return{}},addStorageListener:function(b,c,e,d,g){a.push({tabid:b,id:c,uuid:e,time:d,response:g})},removeStorageListeners:function(b,c){void 0===c&&(c=!0);var e=a;a=[];for(var d in e){var g=e[d];try{void 0!==b.tabid&&b.tabid!==g.tabid||void 0!==b.uuid&&b.uuid!==g.uuid||void 0!==b.id&&b.id!==g.id?
a.push(g):c&&g.response({})}catch(m){D&&console.debug("sb: listener clear for script",b,"failed! Page reload?!")}}},notifyStorageListeners:function(b,c,e){b=b||{};c=c||{};for(var d in a){var g=a[d];try{void 0!==c.uuid&&g.uuid===c.uuid||void 0!==c.tabid&&g.tabid===c.tabid||void 0!==c.id&&g.id===c.id||void 0!==b.tabid&&b.tabid!==g.tabid||void 0!==b.uuid&&b.uuid!==g.uuid||void 0!==b.id&&b.id!==g.id||e&&e(g.response)}catch(m){console.log("sb: listener notification for script",b,"failed! Page reload?!")}}}};
return c}();scbr=z;var Ba=function(){var a=function(a,b){var f=null,l=a.sender,d=this,g=function(b){try{a.postMessage(b)}catch(d){}};if("xhr"==b.method){var l=function(a){g({error:!0,data:a})},m=function(a){g({success:!0,data:a})},k=function(a){g({progress:!0,data:a})},h=function(a){g({timeout:!0,data:a})};b.details.convertBinary=!0;ga(b.details,{onload:m,onreadychange:function(a){g({change:!0,data:a})},onprogress:k,onerror:l,ontimeout:h,ondone:function(){a.disconnect()}})}else if("download"==b.method)l=
function(a){g({error:!0,data:a})},m=function(a){g({success:!0,data:a})},k=function(a){g({progress:!0,data:a})},h=function(a){g({timeout:!0,data:a})},L.start(b.details,{onload:m,onprogress:k,onerror:l,ontimeout:h,ondone:function(){a.disconnect()}});else if("addStorageListener"==b.method)l.tab?(z.addStorageListener(l.tab.id,b.id,b.uuid,(new Date).getTime(),g),f=function(){z.removeStorageListeners({uuid:b.uuid,id:b.id},!1)}):(console.log(e.getMessage("Unable_to_load_storage_due_to_empty_tabID_")),g({error:!0}));
else if("removeStorageListener"==b.method)l.tab?(z.removeStorageListeners({uuid:b.uuid,id:b.id}),g({error:!1})):(console.warn("Unable to remove storage listener due to empty tabID!"),g({error:!0}));else if("saveStorageKey"==b.method)l.tab?b.uuid&&(l=z.getStorageByUid(b.uuid),l.data[b.key]=b.value,l.ts=b.ts,z.setStorageByUid(b.uuid,l),z.notifyStorageListeners({uuid:b.uuid},{id:b.id},function(a){var d={data:{},ts:0};d.data[b.key]=b.value;d.ts=b.ts;var c={storage:d};void 0===d.data[b.key]&&(c.removed=
b.key);a(c)})):console.log(e.getMessage("Unable_to_save_storage_due_to_empty_tabID_")),g({});else if("openInTab"==b.method){f=["active"];m={url:b.details.url};if(b.details.options){for(k=0;k<f.length;k++)void 0!==b.details.options[f[k]]&&(m[f[k]]=b.details.options[f[k]]);b.details.options.insert&&(m.index=l.tab.index+1)}f=function(){d.disconnected=!0;d.tabId&&delete ca[d.tabId]};chrome.tabs.create(m,function(a){d.tabId=a.id;ca[a.id]={onClose:function(){g({close:!0})}};g({success:!0,tabId:a.id})})}else"closeTab"==
b.method&&(d.tabId&&ca[d.tabId]&&chrome.tabs.remove(d.tabId),g({}),window.setTimeout(function(){try{d.disconnected||a.disconnect()}catch(b){}d.disconnected=!0},1E3));f&&a.onDisconnect.addListener(f)};return function(c){if(C.late){var b={};c.onMessage.addListener(function(f){a.apply(b,[c,f])})}else C.registerLateCallback(function(){Ba(c)})}}(),ia={ping:{allow:{insecure:!0},exec:function(a,c,b){b({pong:!0,instanceID:ta,config:{layout:h.values.layout}})}},newTab:{allow:{extpage:!0},exec:function(a,c,
b){chrome.tabs.create({url:a.url},function(a){b({tabId:a.id})})}},getTab:{allow:{script:!0},exec:function(a,c,b){c.tab&&a.uid?(Q[c.tab.id]||(Q[c.tab.id]={}),Q[c.tab.id][a.uid]||(Q[c.tab.id][a.uid]={}),b({data:Q[c.tab.id][a.uid]})):(console.log("bg: unable to process request",c,a),b({data:null}))}},getTabs:{allow:{script:!0},exec:function(a,c,b){if(a.uid){c={};for(var f in Q)c[f]={},c[f]=Q[f][a.uid];b({data:c})}else console.log("bg: unable to process request",c,a),b({data:null})}},setTab:{allow:{script:!0},
exec:function(a,c,b){if(c.tab&&a.uid){Q[c.tab.id]||(Q[c.tab.id]={});var f={},e;for(e in a.tab)f[e]=a.tab[e];Q[c.tab.id][a.uid]=f}else console.log("bg: unable to process request",c,a);b({})}},closeTab:{allow:{script:!0},exec:function(a,c,b){var f=c&&c.tab?c.tab.id:null;f?chrome.tabs.query({windowType:"normal"},function(a){1>=a.length?(console.warn("bg:","refused to close last tab!"),b({error:"refused to close last tab!"})):chrome.tabs.remove(f,function(){b({})})}):b({error:"internal error"})}},copyToClipboard:{allow:{script:!0,
extpage:!0},exec:function(a,c,b){c.tab?ra.copy(a.data):console.log("bg: unable to process request",c,a);b({})}},setOption:{allow:{extpage:!0},exec:function(a,c,b){c="options"==c.extpage||"options"==a.origin;h.values[a.name]=a.value;c?ba.create("options.settings").done(function(a){b({items:a,options:h.values})}).fail(function(a){b({error:a,options:h.values})}):b({})}},reportAnIssue:{allow:{extpage:!0},exec:function(a,c,b){var f,e,d;a.uuid&&(f=z.getByUid(a.uuid))&&f.script&&f.cond&&(c=u.determineOrigin(f.script),
"author"==a.to&&f.script.supportURL?(e={url:f.script.supportURL},d=c?[a.to,c.token,c.id].join(":"):[a.to,e.url].join(":")):c&&(e=c,d=[e.token,e.id].join(":")),e&&(h.values.statistics_enabled&&Z.tS(f.script.name,d,"m"),chrome.tabs.create({url:e.issue_url||e.url,active:!0},function(){})));b({})}},buttonPress:{allow:{extpage:!0},exec:function(a,c,b){var f=function(){b({})};"reset_simple"==a.name?ea.reset(f):"reset_factory"==a.name?ea.factoryReset(f):"create_tesla_data"==a.name?J.createTeslaData().done(function(a){ra.copy({content:M.UTF8.encode(a.join("<br>")),
type:"html"});f()}):"reset_chrome_sync"==a.name?J.reset().always(f):"install_tests"==a.name?(c=ha.framework.prepare(u.doSave,f))&&console.error(c):"enabled"==a.name?(h.values[a.name]=!h.values[a.name],b({})):"externals_delete"==a.name?(T.cleanElement(a.scriptuid,a.url),ba.create("options.scripts").done(function(a){b({items:a,options:h.values})}).fail(function(a){b({error:a,options:h.values})})):"run_script_updates"==a.name?a.scriptuid?(f=function(c){b({scriptuid:a.scriptuid,updatable:c})},aa.check(!0,
!1,a.scriptuid,f)):(aa.check(!0,!0),b({})):(console.log("bg: Warning: unknown button "+a.name),b({}))}},loadTree:{allow:{extpage:!0},exec:function(a,c,b){ba.create(a.referrer,{complete:a.complete,uuid:a.uuid}).done(function(a){b({items:a,i18n:h.values.i18n,options:h.values})}).fail(function(a){b({error:a,options:h.values})})}},modifyScriptOptions:{allow:{extpage:!0},exec:function(a,c,b){if(a.uuid){var f="options"==c.extpage||"options"==a.origin,e=void 0==a.reload||!0==a.reload,d=z.getByUid(a.uuid);
if(d.script&&d.cond){var g=!1,m=new Y.Script,k;for(k in m.options)m.options.hasOwnProperty(k)&&"undefined"!==typeof a[k]&&(d.script.options[k]=a[k]);for(k in m.options.override)m.options.override.hasOwnProperty(k)&&-1!=k.search("merge_")&&"undefined"!==typeof a[k]&&(d.script.options.override[k]=a[k],g=!0);"undefined"!==typeof a.enabled&&(d.script.enabled=a.enabled);"undefined"!==typeof a.includes&&(d.script.options.override.use_includes=a.includes,d.script.options.override.use_excludes=a.excludes,
d.script.options.override.use_matches=a.matches,g=!0);g&&(d.script=u.mergeCludes(d.script));u.doModify(d.script.uuid,d.script).done(function(){e?(void 0!==a.position&&u.reorderScripts(a.uuid,a.position),f?ia.loadTree.exec({referrer:"options.scripts"},c,b):chrome.tabs.getSelected(null,function(d){ba.create("actions").done(function(a){b({items:a,i18n:h.values.i18n,options:{enabled:h.values.enabled,layout:h.values.layout}})}).fail(function(){b({i18n:h.values.i18n,options:{enabled:h.values.enabled,layout:h.values.layout}})});
a.uuid&&h.values.autoReload&&chrome.tabs.sendMessage(d.id,{method:"reload",frameId:0},function(a){})})):b({})}).fail(function(){b({})});return!0}}b({})}},modifyNativeScript:{allow:{extpage:!0},exec:function(a,c,b){if(a.nid){var f=void 0==a.reload||!0==a.reload;P.getUserscriptById(a.nid).then(function(b){if(b)if("installed"==a.actionid){if("false"==a.value)return P.uninstall(b)}else{if("enabled"==a.actionid)return P.setEnabled(b,a.value);if("imported"==a.actionid&&"true"==a.value){var d=P.getUserscriptSource(b);
if(d)return u.doSave({src:d,ask:!0,replace:!0}).then(function(a){if(a.installed){if("disable"==h.values.native_import_post_action)return P.setEnabled(b,!1);if("uninstall"==h.values.native_import_post_action)return P.uninstall(b)}});chrome.tabs.sendMessage(c.tab.id,{method:"showMsg",msg:e.getMessage("Please_double_check_the_native_script_import_settings__")},function(a){})}}else f=!1;return w()}).always(function(){f?ia.loadTree.exec({referrer:"options.scripts"},c,b):b({})});return!0}b({})}},saveScript:{allow:{extpage:!0},
exec:function(a,c,b){var f=void 0===a.reload||!!a.reload,l=function(a){f?ba.create("options.scripts").done(function(d){a.items=d;a.options=h.values;b(a)}).fail(function(a){b({error:a,options:h.values})}):b({})};if(a.clean){D&&console.debug("bg: clean userscript "+a.uuid);c=z.getByUid(a.uuid);var d=function(d){ba.create("options.scripts").done(function(c){b({cleaned:d.installed,items:c,options:h.values});d.installed&&z.notifyStorageListeners({uuid:a.uuid},null,function(b){b({storage:z.getStorageByUid(a.uuid)})})}).fail(function(a){b({error:a,
options:h.values})})};c.script&&c.cond?u.doSave({name:a.name,uuid:a.uuid,src:c.script.textContent,clean:!0,ask:!0,save:!0}).always(function(a){d(a||{installed:!1})}):(console.error(e.getMessage("fatal_error")+" ("+a.uuid+")!!!"),d({installed:!1}))}else a.code?(d=b,f&&(d=function(a){u.reorderScripts();l(a)}),a.new_script&&(a.uuid=s.createUUID()),u.doSave({name:a.name,uuid:a.uuid,force_url:a.force_url,src:a.code,ask:!h.values.editor_easySave,lastModified:a.lastModified,save:!0}).always(function(a){d(a||
{installed:!1})})):(u.doRemove(a.uuid),u.reorderScripts(),l({}))}},exportToJson:{allow:{extpage:!0},exec:function(a,c,b){u.exportToJson(a.ids,a.options).done(function(a){b({json:a})}).fail(function(a){b({})})}},importFromJson:{allow:{extpage:!0},exec:function(a,c,b){var f=void 0===a.reload||!!a.reload,l=null;u.importFromJson(a.json).fail(function(a){l=a||e.getMessage("An_error_occured_during_import_")}).always(function(){var a={};l?(a.err=l,b(a)):f?ba.create("options.scripts").done(function(c){a.items=
c;a.options=h.values;b(a)}).fail(function(a){b({error:a,options:h.values})}):b(a)})}},askCom:{allow:{extpage:!0},exec:function(a,c,b){ka.onMessage(a.data).always(function(a){a.i18n=h.values.i18n;a.options={statistics_enabled:h.values.statistics_enabled};a.ext={version:chrome.extension.manifest.version};b(a)})}},installScript:{allow:{insecure:!0},exec:function(a,c,b){if(c.tab){var f={};u.installFromUrl(a.url).done(function(a){f={data:null,found:!0,installed:a}}).always(function(){b(f)})}else console.log(e.getMessage("Unable_to_install_script_due_to_empty_tabID_"))}},
registerMenuCmd:{allow:{script:!0},exec:function(a,c,b){c.tab?(E.add({tabId:c.tab.id,url:c.tab.url,name:a.name,accessKey:a.accessKey,id:a.menuId,response:b}),Aa()):(console.log("Unable to register menu cmd due to empty tabID!"),b({run:!1}))}},unRegisterMenuCmd:{allow:{script:!0},exec:function(a,c,b){E.clearById(a.id);b({});Aa()}},execMenuCmd:{allow:{extpage:!0},exec:function(a,c,b){(a=E.getById(a.id))?a.response({run:!0,menuId:a.id}):console.error("bg: Error: unable to find MC id "+a.id);b({})}},
getWebRequestInfo:{allow:{script:!0},exec:function(a,c,b){c.tab?b({webRequest:G}):(console.log("Unable to run scripts due to empty tab id"),b({}))}},unLoad:{allow:{script:!0},exec:function(a,c,b){a.topframe||a.id&&y.events.unload(c.tab.id,c.tab.frameId,a.id)}},prepare:{allow:{script:!0},exec:function(a,c,b){if(c.tab){var f=a.topframe?0:null,e=a.url+a.params,d=y.events.prepare(c.tab.id,f,a.id,e);if(la.isAllowed(e)){if(d){d={enabledScriptsCount:d,raw:{},webRequest:G,logLevel:h.values.logLevel};if(a.raw)for(var g=
0;g<a.raw.length;g++)d.raw[a.raw[g]]=Registry.getRaw(a.raw[g]);b(d)}else b({logLevel:h.values.logLevel});y.events.run(c.tab.id,f,a.id,e,function(){W.setIcon(c.tab.id);W.setBadge(c.tab.id)});F.tab.resetFireCnt(c.tab.id)}else D&&console.log("This URL is filtered by the security settings:",e,"-> Do nothing!"),a.id&&y.set.forbidden(c.tab.id,f,a.id),b({})}else b({});return!1}},scriptBlockerDetected:{allow:{script:!0},exec:function(a,c,b){a.xml_style_detected||-1!=a.url.search("\\.xml$")?console.warn("blocker: unable to get unsafeWindow..."):
I.requestPermissionEx(function(a,c){var d=a&&c?e.getMessage("Please_reload_this_page_in_order_to_run_your_userscripts_"):null;b({alert:d})});y.set.blocker(c.tab.id);W.setIcon(c.tab.id)}},startFireUpdate:{allow:{extpage:!0},exec:function(a,c,b){F.checkUpdate(!0,a.force,function(a){b({suc:a})})}},getFireItems:{allow:{extpage:!0},exec:function(a,c,b){var f=function(d,c,f){void 0==c&&(c=null);var e=function(a){try{b({image:a,cnt:d,scripts:c,progress:f,options:{fire_sort_cache_enabled:h.values.fire_sort_cache_enabled}}),
c=[]}catch(e){console.warn("bg: warn: action menu closed? ",e)}};a.countonly?e(null):Ea.createIconEx(d).done(e)};if(!F.isReady())return f(0,[],{action:F.status.action,state:F.status.progress}),!0;var e=function(b){var c=Ka(a,b);f(b.length,c)};a.tabid?a.countonly?F.tab.getCount(a.tabid,f):F.tab.getItems(a.tabid,e):a.url?"*"==a.url?F.getMax("scripts","sid",function(a){for(var b=[],c=0;1E3>c;c++)b.push(Math.floor(Math.random()*a+1).toString());F.ids.getItems(b,e)}):a.countonly?F.url.getCount(a.url,f):
F.url.getItems(a.url,e):f([],[])}},notification:{allow:{script:!0,extpage:!0},exec:function(a,c,b){c=a.image&&""!=a.image?a.image:chrome.extension.getURL("images/icon128.png");N.show(a.title,a.msg,c,a.delay,function(a){b({clicked:a.clicked})})}},syntaxCheck:{allow:{script:!0,extpage:!0},exec:function(a,c,b){(function(){var a=v();Registry.require("hinter",function(){a.resolve(Registry.get("hinter"))});return a.promise()})().then(function(b){return b.hint(a.code,{maxerr:999},{})}).always(function(a){b({errors:a})})}},
handler:function(a,c,b){if(!C.late)return C.registerLateCallback(function(){ia.handler(a,c,b)}),!0;var f=ia[a.method];if(f)if(f.allow&&f.exec){var e=n.SELF.ID,e=!n.REQUESTS.HAS_SENDER_ID&&c.tab||c.id===e,d=null,g=n.REQUESTS.INTERNAL_PAGE_URL,m=n.REQUESTS.GET_INTERNAL_PAGE_REGEXP(),g=e&&(!c.tab||0==c.tab.url.search(g));e&&g&&(c.tab?(m=c.tab.url.match(m))&&2==m.length&&(d=m[1]):d="*",c.extpage=d);if("background"==d||f.allow.insecure||f.allow.extpage&&g||f.allow.options&&"options"==d||f.allow.script&&
e&&!g){if(f=f.exec(a,c,b),void 0!==f)return f}else return D&&console.warn("back: this context doesn't have the permission to call '"+a.method+"' "),!1}else return console.log("b: invalid implementation of "+a.method),!1;else return console.log("back: unknown method "+a.method),!1;return!0}},La=function(){var a=[],c=["test"],b=!1;return{getLayouts:function(){b||(a.push({name:e.getMessage("Default"),value:"default"}),Registry.isDevVersion("helper")&&c.forEach(function(b){Registry.getRaw("layout/"+b+
"/options.js")&&a.push({name:b.charAt(0).toUpperCase()+b.slice(1),value:b})}),b=!0);return a}}}(),E={commands:[],add:function(a){E.commands.push(a)},list:function(){var a=[],c;for(c in E.commands)E.commands.hasOwnProperty(c)&&a.push(E.commands[c]);return a},listByTabId:function(a){var c=[],b;for(b in E.commands)if(E.commands.hasOwnProperty(b)){var f=E.commands[b];if(f.tabId==a){for(var e=!1,d=0;d<c.length;d++)if(c[d].name==f.name){e=!0;break}e||c.push(f)}}return c},clearByTabId:function(a){E.getByTabId(a)},
getByTabId:function(a){var c=[],b=E.commands;E.commands=[];for(var f in b)if(b.hasOwnProperty(f)){var e=b[f];e.tabId!=a?E.commands.push(e):c.push(e)}return c},clearById:function(a){E.getById(a)},getById:function(a){var c=null,b=E.commands;E.commands=[];for(var e in b)if(b.hasOwnProperty(e)){var h=b[e];h.id!=a?E.commands.push(h):c=h}return c}},Ka=function(a,c){var b=[],f="http://...";a.tabid&&!y.get.empty(a.tabid)?s.each(y.get.urls(a.tabid),function(a,b){f=b;return!0}):a.url&&(f=a.url);var h=c.length?
" ("+c.length+")":"",h={name:e.getMessage("Available_Userscripts")+h,main_menu_item:!0,selected_default:!0,scriptTab:!0};h.items=na(c,!1,!0);b.push(h);var h={name:e.getMessage("Settings"),main_menu_item:!0},d={name:e.getMessage("General"),sub_menu_item:!0},g="",m,k=S.getConfig();0==k.fire.db_version?g="?":(m=1E3*k.fire.db_version,g=(new Date(m)).toString());g=[e.getMessage("Current_Index_")+":","",e.getMessage("Date_")+": "+g,e.getMessage("Entries_")+": "+(k.fire.entries?k.fire.entries:"?"),"","",
""];d.items=[{name:"TamperFire DB",fire:!0,fireInfo:!0,value:g,versionDB:m},{name:e.getMessage("Check_for_Updates"),fname:e.getMessage("Force_Update"),fire:!0,fireUpdate:!0}];h.items=[d];b.push(h);b.push({name:"Search by URL",id:"searchByURL",search:!0,value:f,desc:""});return b},Ma=function(){return{create:function(){var a,c,b,f,l,d,g,m,k,x,p,r;k=null;a={name:e.getMessage("General"),sub_menu_item:!0,items:[]};a.items.push({name:e.getMessage("Config_Mode"),id:"configMode",level:0,option:!0,select:[{name:e.getMessage("Novice"),
value:0},{name:e.getMessage("Beginner"),value:50},{name:e.getMessage("Advanced"),value:100}],value:h.values.configMode,desc:e.getMessage("Changes_the_number_of_visible_config_options")});a.items.push({name:"Language",id:"i18n",level:0,option:!0,reload:!0,warning:{msg:e.getMessage("A_reload_is_required")},select:[{name:"Browser Default",value:null},{name:e.getOriginalMessage("English"),value:"en"},{name:e.getOriginalMessage("German"),value:"de"},{name:e.getOriginalMessage("French"),value:"fr"},{name:e.getOriginalMessage("Italian"),
value:"it"},{name:e.getOriginalMessage("Russian"),value:"ru"},{name:e.getOriginalMessage("Spanish"),value:"es"},{name:e.getOriginalMessage("Polish"),value:"pl"},{name:e.getOriginalMessage("Portuguese_Brazil"),value:"pt-br"},{name:e.getOriginalMessage("Chinese__Simplified_"),value:"zh_CN"},{name:e.getOriginalMessage("Chinese__Traditional_"),value:"zh_TW"},{name:e.getOriginalMessage("Japanese"),value:"ja"}],value:h.values.i18n,validation:{image:"info",opacity:0.9,msg:e.getMessage("Your_language_is_not_supported__Click_here_to_get_intructions_how_to_translate_TM_"),
url:"http://tampermonkey.net/faq.php#Q500"}});a.items.push({name:e.getMessage("Make_includes_more_safe"),id:"safeUrls",level:60,option:!0,checkbox:!0,enabled:h.values.safeUrls,desc:e.getMessage("Includes_more_safe_example")});a.items.push({name:e.getMessage("Fix_includes"),id:"tryToFixUrl",level:60,option:!0,checkbox:!0,enabled:h.values.tryToFixUrl,desc:e.getMessage("Fix_includes_example")});a.items.push({name:e.getMessage("Auto_reload_on_script_enabled"),level:20,id:"autoReload",option:!0,checkbox:!0,
enabled:h.values.autoReload,desc:e.getMessage("Auto_reload_on_script_enabled_desc")});a.items.push({name:e.getMessage("Anonymous_statistics"),level:0,id:"statistics_enabled",option:!0,checkbox:!0,enabled:h.values.statistics_enabled,desc:e.getMessage("Allow_Tampermonkey_to_collect_anonymous_statistics_via_Google_Analytics")});a.items.push({name:e.getMessage("Debug_scripts"),level:100,id:"debug",option:!0,checkbox:!0,enabled:h.values.debug,desc:""});a.items.push({name:e.getMessage("Show_fixed_source"),
level:100,id:"showFixedSrc",option:!0,checkbox:!0,enabled:h.values.showFixedSrc,desc:""});a.items.push({name:e.getMessage("LogLevel"),id:"logLevel",level:0,option:!0,select:[{name:e.getMessage("Debug"),value:60},{name:e.getMessage("Error"),value:0}],value:h.values.logLevel,desc:""});c={name:e.getMessage("Native_Script_Import"),sub_menu_item:!0,need_save:!0,items:[]};k={};h.values.native_import&&(k=!0===n.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS?{image:"button_ok",msg:e.getMessage("TM_has_access_to_file_URIs")}:
{image:"critical",msg:e.getMessage("Tampermonkey_needs_access_to_file_URIs__Visit_the_FAQ_"),url:"http://tampermonkey.net/faq.php#Q204"});c.items.push({name:e.getMessage("Enable_Native_Script_Import"),id:"native_import",level:0,option:!0,checkbox:!0,enabled:h.values.native_import,validation:k});c.items.push({name:e.getMessage("Post_Import_Action"),id:"native_import_post_action",level:0,option:!0,select:[{name:e.getMessage("None"),value:"none"},{name:e.getMessage("Disable_Extension"),value:"disable"},
{name:e.getMessage("Uninstall_Extension"),value:"uninstall"}],value:h.values.native_import_post_action,desc:e.getMessage("What_action_should_be_done_after_a_native_userscript_was_imported_sucessfully_")});k={};h.values.native_import&&(k=P.isPathValid()?{image:"button_ok",msg:e.getMessage("Everything_is_setup_correctly_")}:{image:"critical",msg:e.getMessage("Tampermonkey_needs_to_know_the_absolute_path_to_your_browser_profile_folder_Visit_the_FAQ_"),url:"http://tampermonkey.net/faq.php#Q205"});c.items.push({name:e.getMessage("Browser_Profile_Path"),
id:"native_import_path",level:0,option:!0,text:!0,width:2,value:h.values.native_import_path,validation:k});n.OPTIONS.HAS_TESLA&&(x={name:e.getMessage("TESLA"),sub_menu_item:!0,level:50,need_save:!0,items:[]},x.items.push({name:e.getMessage("Enable_TESLA"),id:"sync_enabled",level:50,option:!0,checkbox:!0,enabled:h.values.sync_enabled,desc:e.getMessage("Tampermonkey_External_Script_List_Access")}),b=[{name:"pastebin.com",value:K.types.ePASTEBIN,enable:{sync_id:!0,sync_version:!1,create_tesla_data:!0}},
{name:"Chrome Sync",value:K.types.eCHROMESYNC,enable:{sync_id:!1,sync_version:!0,create_tesla_data:!1}}],n.SYNC.GOOGLE_DRIVE.SUPPORTED&&b.push({name:"Google Drive (Beta)",value:K.types.eGOOGLEDRIVE,enable:{sync_id:!1,sync_version:!1,create_tesla_data:!1}}),x.items.push({name:e.getMessage("Sync_Type"),id:"sync_type",enabler:!0,level:50,option:!0,select:b,value:h.values.sync_type}),x.items.push({name:e.getMessage("Sync_Id"),id:"sync_id",enabledBy:"sync_type",level:50,text:!0,value:h.values.sync_id,
option:!0}),x.items.push({name:e.getMessage("Sync_Version"),id:"sync_version",enabledBy:"sync_type",level:50,option:!0,select:[{name:"v1 - Legacy",value:1},{name:"v2 - Beta",value:2,warning:{msg:e.getMessage("This_sync_version_may_multiply_each_script_that_is_present_at_more_than_one_Tampermonkey_instance__Do_you_really_want_to_continue_")}}],value:h.values.sync_version,desc:e.getMessage("Different_sync_versions_are_not_compatible_to_each_other_")}),x.items.push({name:e.getMessage("Create_Exportable_Data"),
id:"create_tesla_data",enabledBy:"sync_type",button:!0,ignore:!0,level:60,warning:{msg:e.getMessage("Copy_exportable_data_to_clipboard_Ok_")}}));l={name:e.getMessage("Appearance"),sub_menu_item:!0,items:[]};l.items.push({name:e.getMessage("Layout"),id:"layout",level:0,option:!0,select:La.getLayouts(),value:h.values.layout,desc:""});k={};"off"==h.values.notification_showUpdate&&(k={image:"critical",msg:e.getMessage("Are_you_sure_that_you_don_t_want_to_be_notified_of_updates_")});l.items.push({name:e.getMessage("Update_Notification"),
id:"notification_showUpdate",level:50,option:!0,select:[{name:e.getMessage("Off"),value:"off"},{name:e.getMessage("Show_notification"),value:"notification"},{name:e.getMessage("Open_changelog"),value:"changelog"}],value:h.values.notification_showUpdate,validation:k});l.items.push({name:e.getMessage("Icon_badge_info"),id:"appearance_badges",level:50,option:!0,select:[{name:e.getMessage("Off"),value:"off"},{name:e.getMessage("Running_scripts"),value:"running"},{name:e.getMessage("Unique_running_scripts"),
value:"running_unique"},{name:e.getMessage("Disabled_scripts"),value:"disabled"},{name:"TamperFire",value:"tamperfire"}],value:h.values.appearance_badges});n.OPTIONS.HAS_TAMPERFIRE&&(m={name:e.getMessage("TamperFire"),sub_menu_item:!0,items:[]},m.items.push({name:e.getMessage("Enable_TamperFire"),id:"fire_enabled",level:0,option:!0,checkbox:!0,enabled:h.values.fire_enabled,desc:e.getMessage("Searches_for_scripts_that_can_be_used_on_the_current_page_")}),m.items.push({name:e.getMessage("Use_top_frame_URL_only"),
id:"fire_topOnly",level:0,option:!0,checkbox:!0,enabled:h.values.fire_topOnly,desc:""}),m.items.push({name:e.getMessage("Enable_Sort_Cache"),id:"fire_sort_cache_enabled",level:100,checkbox:!0,option:!0,enabled:h.values.fire_sort_cache_enabled,desc:""}),m.items.push({name:e.getMessage("Update_interval"),id:"fire_updatePeriod",level:50,option:!0,select:[{name:e.getMessage("Never"),value:0},{name:e.getMessage("Every_Day"),value:864E5},{name:e.getMessage("Every_Week"),value:6048E5},{name:e.getMessage("Every_2_Weeks"),
value:12096E5},{name:e.getMessage("Every_Month"),value:2592E6}],value:h.values.fire_updatePeriod,desc:""}));b={name:e.getMessage("Editor"),sub_menu_item:!0,level:20,items:[]};b.items.push({name:e.getMessage("Enable_Editor"),id:"editor_enabled",level:100,option:!0,checkbox:!0,enabled:h.values.editor_enabled,reload:!0,warning:{msg:e.getMessage("A_reload_is_required")},desc:""});b.items.push({name:e.getMessage("Key_Mapping"),id:"editor_keyMap",level:50,option:!0,reload:!0,warning:{msg:e.getMessage("A_reload_is_required")},
select:[{name:e.getMessage("Windows"),value:"windows"},{name:e.getMessage("Emacs"),value:"emacs"},{name:e.getMessage("Vim"),value:"vim"}],value:h.values.editor_keyMap});b.items.push({name:e.getMessage("Indentation_Width"),id:"editor_indentUnit",level:50,option:!0,select:[{name:e.getMessage("1"),value:1},{name:e.getMessage("2"),value:2},{name:e.getMessage("3"),value:3},{name:e.getMessage("4"),value:4},{name:e.getMessage("5"),value:5},{name:e.getMessage("6"),value:6},{name:e.getMessage("7"),value:7},
{name:e.getMessage("8"),value:8},{name:e.getMessage("9"),value:9},{name:e.getMessage("10"),value:10},{name:e.getMessage("11"),value:11}],value:h.values.editor_indentUnit,desc:""});b.items.push({name:e.getMessage("Indent_with"),id:"editor_indentWithTabs",level:50,option:!0,select:[{name:e.getMessage("Tabs"),value:"tabs"},{name:e.getMessage("Spaces"),value:"spaces"}],value:h.values.editor_indentWithTabs,desc:""});b.items.push({name:e.getMessage("TabMode"),id:"editor_tabMode",level:50,option:!0,select:[{name:e.getMessage("Classic"),
value:"classic"},{name:e.getMessage("Smart"),value:"smart"}],value:h.values.editor_tabMode,desc:""});b.items.push({name:e.getMessage("Reindent_on_typing"),id:"editor_electricChars",level:50,option:!0,checkbox:!0,enabled:h.values.editor_electricChars,desc:""});b.items.push({name:e.getMessage("Enable_autoSave"),id:"editor_autoSave",level:20,option:!0,checkbox:!0,enabled:h.values.editor_autoSave,desc:""});b.items.push({name:e.getMessage("Enable_easySave"),id:"editor_easySave",level:20,option:!0,checkbox:!0,
enabled:h.values.editor_easySave,desc:""});f={name:e.getMessage("Script_Update"),sub_menu_item:!0,level:0,items:[]};f.items.push({name:e.getMessage("Check_disabled_scripts"),id:"scriptUpdateCheckDisabled",level:0,option:!0,checkbox:!0,enabled:h.values.scriptUpdateCheckDisabled,desc:""});f.items.push({name:e.getMessage("Check_interval"),id:"scriptUpdateCheckPeriod",level:0,option:!0,select:[{name:e.getMessage("Never"),value:0},{name:e.getMessage("Every_Hour"),value:36E5},{name:e.getMessage("Every_6_Hours"),
value:216E5},{name:e.getMessage("Every_12_Hour"),value:432E5},{name:e.getMessage("Every_Day"),value:864E5},{name:e.getMessage("Every_Week"),value:6048E5}],value:h.values.scriptUpdateCheckPeriod,desc:""});f.items.push({name:e.getMessage("Dont_ask_me_for_simple_script_updates"),id:"notification_silentScriptUpdate",level:80,option:!0,checkbox:!0,enabled:h.values.notification_silentScriptUpdate,desc:""});f.items.push({name:e.getMessage("Hide_notification_after"),id:"scriptUpdateHideNotificationAfter",
level:50,option:!0,select:[{name:e.getMessage("Never"),value:0},{name:e.getMessage("15_Seconds"),value:15E3},{name:e.getMessage("30_Seconds"),value:3E4},{name:e.getMessage("1_Minute"),value:6E4},{name:e.getMessage("5_Minutes"),value:3E5},{name:e.getMessage("1_Hour"),value:36E5}],value:h.values.scriptUpdateHideNotificationAfter,desc:""});d={name:e.getMessage("Security"),sub_menu_item:!0,level:50,items:[]};n.OPTIONS.HAS_CSP&&(d.items.push({name:e.getMessage("Allow_overwrite_javascript_settings"),id:"scriptblocker_overwrite",
level:80,option:!0,select:[{name:e.getMessage("Yes"),value:"yes"},{name:e.getMessage("No"),value:"no"}],value:h.values.scriptblocker_overwrite,desc:e.getMessage("Tampermonkey_can_not_work_when_javascript_is_disabled")}),d.items.push({name:e.getMessage("Add_TM_to_CSP"),id:"webrequest_fixCSP",level:80,option:!0,select:[{name:e.getMessage("Yes"),value:"yes"},{name:e.getMessage("No"),value:"no"}],value:h.values.webrequest_fixCSP,desc:e.getMessage("Tampermonkey_might_not_be_able_to_provide_access_to_the_unsafe_context_when_this_is_disabled")}),
d.items.push({name:e.getMessage("Allow_headers_to_be_modified_by_scripts"),id:"webrequest_modHeaders",level:80,option:!0,select:[{name:e.getMessage("Yes"),value:"yes"},{name:e.getMessage("Auto"),value:"auto"},{name:e.getMessage("No"),value:"no"}],value:h.values.webrequest_modHeaders,desc:""}));chrome.extension.inIncognitoContext||(k="temporary"==h.values.incognito_mode?{}:{image:"critical",msg:"Permanent mode is still a BETA feature!"},d.items.push({name:e.getMessage("Store_data_in_incognito_mode"),
id:"incognito_mode",level:50,option:!0,select:[{name:e.getMessage("Temporary"),value:"temporary"},{name:e.getMessage("Permanent"),value:"permanent"}],value:h.values.incognito_mode,validation:k}));d.items.push({name:e.getMessage("Page_Filter_Mode"),id:"page_filter_mode",level:50,option:!0,select:[{name:e.getMessage("Off"),value:"off"},{name:e.getMessage("Blacklist"),value:"black"},{name:e.getMessage("Whitelist"),value:"white"},{name:e.getMessage("Both"),value:"black+white"}],value:h.values.page_filter_mode,
desc:""});d.items.push({name:e.getMessage("Whitelisted_Pages"),id:"page_whitelist",level:50,option:!0,input:!0,array:!0,value:h.values.page_whitelist,desc:""});d.items.push({name:e.getMessage("Blacklisted_Pages"),id:"forbiddenPages",level:50,option:!0,input:!0,array:!0,value:h.values.forbiddenPages,desc:""});g={name:e.getMessage("BlackCheck"),sub_menu_item:!0,level:50,items:[]};g.items.push({name:e.getMessage("Script_Blacklist_Source"),id:"script_blacklist_type",level:50,option:!0,select:[{name:e.getMessage("Off"),
value:"off"},{name:e.getMessage("Server_And_Manual"),value:"server"},{name:e.getMessage("Only_Manual"),value:"only_manual"}],value:h.values.script_blacklist_type});g.items.push({name:e.getMessage("Blacklist_Severity"),id:"script_blacklist_severity",level:50,option:!0,select:[{name:e.getMessage("severity_1"),value:1},{name:e.getMessage("severity_2"),value:2},{name:e.getMessage("severity_3"),value:3},{name:e.getMessage("severity_4"),value:4},{name:e.getMessage("severity_5"),value:5},{name:e.getMessage("severity_6"),
value:6},{name:e.getMessage("severity_7"),value:7},{name:e.getMessage("severity_8"),value:8},{name:e.getMessage("severity_9"),value:9},{name:e.getMessage("severity_10"),value:10}],value:h.values.script_blacklist_severity});g.items.push({name:e.getMessage("Manual_Script_Blacklist"),id:"require_blacklist",level:50,option:!0,input:!0,array:!0,value:h.values.require_blacklist,desc:""});var q=!1;k={};s.map("exe sh crx com bat scr".split(" "),function(a){return"name."+a}).forEach(function(a){q|=L.is_whitelisted(a)});
q&&(k={image:"critical",msg:e.getMessage("Your_whitelist_seems_to_include_executable_files_This_means_your_userscripts_may_download_malware_or_spyware_to_your_harddisk_")});r={name:e.getMessage("Downloads")+" BETA",sub_menu_item:!0,level:50,items:[]};r.items.push({name:e.getMessage("Download_Mode"),id:"downloads_mode",level:50,option:!0,select:s.select([{name:e.getMessage("Default"),value:L.staticVars.DEFAULT},{name:e.getMessage("Off"),value:L.staticVars.OFF},{name:e.getMessage("Native"),value:L.staticVars.NATIVE},
{name:e.getMessage("Browser_API"),value:n.DOWNLOAD.SUPPORTED?L.staticVars.CHROME:null}],function(a){return a.value}),value:h.values.downloads_mode,desc:e.getMessage("The_Browser_API_mode_requires_a_special_permission_")+"\n'Default' is 'Native'."});r.items.push({name:e.getMessage("Whitelisted_File_Extensions"),id:"downloads_extension_whitelist",level:50,option:!0,input:!0,array:!0,value:h.values.downloads_extension_whitelist,desc:e.getMessage("Only_files_with_these_extensions_can_be_saved_to_the_harddisk_Be_careful_to_not_allow_file_extensions_that_represent_executables_at_your_operating_system_"),
validation:k});k={name:e.getMessage("Userscripts"),sub_menu_item:!0,level:80,items:[]};k.items.push({name:e.getMessage("New_script_template_"),id:"scriptTemplate",level:80,option:!0,input:!0,value:h.values.scriptTemplate});p={name:e.getMessage("Reset_Section"),sub_menu_item:!0,level:50,items:[]};p.items.push({name:e.getMessage("Restart_Tampermonkey"),id:"reset_simple",level:50,button:!0,reload:!0,value:0,warning:{msg:e.getMessage("This_will_restart_Tampermonkey_Ok_")}});p.items.push({name:e.getMessage("Factory_Reset"),
id:"reset_factory",level:80,button:!0,reload:!0,value:0,warning:{msg:e.getMessage("This_will_remove_all_scripts_and_reset_all_settings_Ok_")}});n.OPTIONS.HAS_TESLA&&p.items.push({name:e.getMessage("Chrome_Sync_Reset"),id:"reset_chrome_sync",level:80,button:!0,reload:!0,value:0,warning:{msg:e.getMessage("This_will_remove_all_stored_data_from_google_sync_Ok_")}});ha&&p.items.push({name:"Install Tests",id:"install_tests",level:80,button:!0,reload:!1,ignore:!0,value:0,warning:{msg:"This will install a lot of test scripts!"}});
return s.select([a,l,f,void 0,x,c,m,b,d,g,r,k,p],function(a){return!!a})}}}(),ba=function(){return{create:function(a,c){a=a||"";c=c||{};var b=function(a){var b=[],c=v();a.concat([w()]).reduce(function(a,d){return a.done(function(a){a&&(b=b.concat("Array"===s.toType(a)?a:[a]))}).then(d,function(){console.warn("tree: wait failed!")})},w()).then(function(){c.resolve(b)}).fail(c.reject);return c.promise()},f=function(a,b){for(var e=a.replace(/\.$/,"").split("."),f=l;e.length;){var h=e.shift();if(f[h]){if("function"===
typeof f[h])return function(){return f[h](c,!b)};f=f[h];e.length||e.unshift("root")}else return console.warn("tree: unable to find",a,c),function(){return w([])}}console.warn("tree: unable to find",a,c);return function(){return w([])}},l={actions:{root:function(){var a=v();chrome.tabs.getSelected(null,function(e){c.tab=e;b([f("actions.general"),f("actions.scripts"),f("actions.commands")]).done(function(b){a.resolve(b)}).fail(a.reject)});return a.promise()},general:function(){var a=c.tab,b=a?a.url:
null,f=b&&4<b.length&&""==b.substr(0,4).replace(/file|http/,"")?b:"",k=[],l={name:"enabled",sub_menu_item:!0,pos:"top",items:[]};l.items.push({name:e.getMessage("Enabled"),display:h.values.enabled?null:"greyed",id:"enabled",button:!0,reload:!0,enabler:!0});k.push(l);if(h.values.fire_enabled){var l={name:"fire",sub_menu_item:!0,pos:"top",items:[]},p=null,p=h.values.fire_topOnly?chrome.extension.getURL("fire.html?url="+encodeURIComponent(b)):chrome.extension.getURL("fire.html?tab="+a.id);l.items.push({name:e.getMessage("_0_scripts_found"),
image:"download",doneImage:"fire",tabid:a.id,tamperfire:!0,url:p,newtab:!0});k.push(l)}a={name:"about",sub_menu_item:!0,pos:"bottom",items:[]};a.items.push({name:e.getMessage("Dashboard"),image:"utilities",url:chrome.extension.getURL("options.html")+"?"+["url="+encodeURIComponent(f),"selected=dashboard"].join("&"),newtab:!0});f="version="+chrome.extension.getVersion()+"&ext="+n.SELF.ID.substr(0,4);a.items.push({image:"info",urls:[{name:" "+e.getMessage("Help"),url:"http://tampermonkey.net/faq.php?"+
f,newtab:!0},{name:" "+e.getMessage("Changelog"),url:"http://tampermonkey.net/changelog.php?"+f,newtab:!0}]});k.push(a);return w(k)},scripts:function(){var a=c.tab,b=a?a.url:null,f=[],k=b&&4<b.length&&""==b.substr(0,4).replace(/file|http/,"")?b:"",l={name:"scripts",sub_menu_item:!0,pos:"right",items:[]},a=u.getUniqueScriptsForTab(a),a=na(a);l.items=l.items.concat(a);h.values.enabled&&!a.length&&b&&(la.isAllowed(b)?l.items.push({name:e.getMessage("No_script_is_running"),image:"info"}):l.items.push({name:e.getMessage("This_page_is_blacklisted_at_the_security_settings"),
image:"critical"}));h.values.enabled&&(100>h.values.configMode||!a.length)&&(l.items.push({name:e.getMessage("Get_new_scripts___"),image:"script_download",url:"http://tampermonkey.net/scripts.php",newtab:!0}),l.items.push({name:e.getMessage("Add_new_script___"),image:"script_add",url:chrome.extension.getURL("options.html")+"?url="+encodeURIComponent(k)+"#open=new-user-script",newtab:!0}));f.push(l);return w(f)},commands:function(){var a=[],b={name:"commands",id:"commands",sub_menu_item:!0,pos:"left",
items:[]},f=c.tab.id,h=[],f=null==f||void 0==f?E.list():E.listByTabId(f),l;for(l in f)if(f.hasOwnProperty(l)){var n=f[l];h.push({name:n.name,id:n.id,accessKey:n.accessKey,image:"menu_cmd",menucmd:!0})}h.length&&(b.items=h);b.items.push({name:e.getMessage("Check_for_userscripts_updates"),id:"run_script_updates",button:!0,image:"update"});b.items.push({name:e.getMessage("Report_a_bug"),image:"bug",url:"http://tampermonkey.net/bug",newtab:!0});b.items.push({name:e.getMessage("Please_consider_a_donation"),
image:"donation",url:"http://tampermonkey.net/donate.html",newtab:!0});a.push(b);return w(a)}},options:{root:function(){return b([f("options.general"),f("options.verification"),f("options.scripts"),f("options.settings")])},general:function(){var a=[];a.push({name:"Version",id:null,version:!0,value:chrome.extension.getVersion()});chrome.extension.inIncognitoContext&&"temporary"==h.values.incognito_mode&&a.push({globalhint:!0,image:"critical",value:e.getMessage("All_modifications_are_only_kept_until_this_incognito_session_is_closed_")});
return w(a)},verification:function(){var a=[];ja.getWarnings().forEach(function(b){a.push({globalhint:!0,image:"critical",value:b.text,description:b.description,info_url:b.url})});return w(a)},scripts:{root:function(a,c){var h=v(),k={name:e.getMessage("Installed_userscripts"),main_menu_item:!0,scriptTab:!0,id:"dashboard"};(function(){if(a.complete||!c)return b(s.map(["options.scripts.natives","options.scripts.userscripts","options.scripts.new"],function(a){return f(a)}));k.referrer="options.scripts";
k.partial=!0;return b([f("options.scripts.new")])})().done(function(a){k.items=a;h.resolve([k])}).fail(h.reject);return h.promise()},"new":function(){var a=[];a.push({name:e.getMessage("New_userscript"),id:null,image:"script_add",icon:chrome.extension.getURL("images/txt.png"),code:h.values.scriptTemplate,nnew:!0,uuid:"new-user-script",position:-1,positionof:n.RUNTIME.MAX_SCRIPTS,enabled:!0,userscript:!0});return w(a)},natives:function(){var a=[],b=v();P.getAllUserscripts().always(function(c){c=c||
[];c.forEach(function(b){a.push({name:b.name,uuid:b.id,icon:b.icon,code:null,position:0,positionof:n.RUNTIME.MAX_SCRIPTS,enabled:b.enabled,version:b.version,description:b.description,nativeScript:!0})});b.resolve(a)});return b.promise()},userscripts:{root:function(a,b){var c=a.complete||!b?null:"options.scripts.userscripts.source",c=na(u.determineScriptsToRun(null),!0,!1,c),f=c.length;c.push({name:e.getMessage("No_script_is_installed"),image:"info",visible:!f});c.push({name:e.getMessage("Get_some_scripts___"),
image:"edit_add",url:"http://tampermonkey.net/scripts.php",newtab:!0,visible:!f});return w(c)},source:function(a){if(!a.uuid)return w({});a=z.getByUid(a.uuid);if(a.script&&a.cond)return a=h.values.showFixedSrc?ma.mkCompat(a.script.textContent,a.script,!1):a.script.textContent,w([a]);console.warn("tree: unable to process ",a);return O()}}},settings:function(a,b){var c=v(),f={name:e.getMessage("Settings"),main_menu_item:!0,id:"settings",selected_default:!0},h;a.complete||!b?h=w(Ma.create()):(f.referrer=
"options.settings",h=w());h.done(function(a){f.items=a;c.resolve([f])}).fail(c.reject);return c.promise()}}};D&&console.log("tree: loading",a,c);return f(a,!0)()}}}(),na=function(a,c,b,f){var e=[],d=new Y.Script;["author","copyright"].forEach(function(a){d[a]=!1});for(var g in a){var m=a[g],k;if(c){k={};for(var n in d)d.hasOwnProperty(n)&&"textContent"!=n&&"requires"!=n&&"resources"!=n&&(s.toType(d[n]),k[n]=m[n]);f?k.referrer=f:k.code=m.textContent;k.requires=s.map(m.requires,function(a){return T.getElement(m.uuid,
a.url)||{url:a.url}});k.resources=s.map(m.resources,function(a){return T.getElement(m.uuid,a.url)||{url:a.url}});k.origin=u.determineOrigin(m)}else k=b?m:{name:m.name,uuid:m.uuid,system:m.system,support:!!m.supportURL,origin:!!u.determineOrigin(m),enabled:m.enabled,position:m.position};k.blacklisted=m.evilness>=h.values.script_blacklist_severity;k.file_url=m.downloadURL||m.fileURL;k.positionof=a.length;k.userscript=m.options.user_agent?!1:!0;k.user_agent=m.options.user_agent;m.icon64||m.icon||(k.icon64=
chrome.extension.getURL(k.user_agent?"images/user_agent.png":"images/txt.png"));if(m.options)for(n in d.options)d.options.hasOwnProperty(n)&&(k[n]=m.options[n]);e.push(k)}return e},ra={copy:function(a){var c=document.createElement("iframe");document.body.appendChild(c);try{c.contentDocument.designMode="on","html"==a.type?(c.setAttribute("sandbox","allow-same-origin"),c.contentDocument.documentElement.innerHTML=a.content,c.contentDocument.execCommand("selectAll",!1,null)):c.contentDocument.oncopy=
function(b){b.clipboardData.setData(a.mimetype||"text/plain",a.content);b.preventDefault()},c.contentDocument.execCommand("copy",!1,null),c.contentDocument.designMode="off"}catch(b){console.error("bg: clipboard Error: "+b.message)}c.parentNode.removeChild(c);c=null}};clip=ra;var I={asked:!1,runCheck:!1,hasPermission:!1,init:function(){U.has(U.permContentSettings).done(function(a){I.hasPermission=a;I.runCheck=I.hasPermission&&"yes"==h.values.scriptblocker_overwrite;D&&console.log("bg: contentSettings: runCheck = "+
I.runCheck+" hasPerm = "+I.hasPermission)})},askForPermission:function(a){U.ask(U.permContentSettings,e.getMessage("A_script_blocker_was_detected_"),e.getMessage("Click_here_to_allow_TM_to_override_the_script_blocker")).done(a)},requestPermissionEx:function(a){"yes"!=h.values.scriptblocker_overwrite?a&&a():U.has(U.permContentSettings).done(function(c){I.asked?a&&a(c,!1):c?a(c,!1):I.askForPermission(function(b){a&&a(b,!0);b&&!I.runCheck&&(I.runCheck=!0,ea.reset())});I.asked=!0})},remove:function(a){U.remove(U.permContentSettings).done(a)}},
ea={run:function(a,c){var b=1,f=function(){0==--b&&(c&&c(),window.location.reload())};if("config"==a){var e=p.listValues(),d;for(d in e){var g=e[d];-1!=g.search(n.CONSTANTS.PREFIX.SCRIPT)&&-1!=g.search(n.CONSTANTS.PREFIX.COND)&&-1!=g.search(n.CONSTANTS.PREFIX.STORE)&&-1!=g.search(n.CONSTANTS.PREFIX.META)&&(b++,p.deleteValue(g).always(f))}}else"factory"==a&&(F.isReady()&&(b++,F.clean(f)),I.hasPermission&&(b++,I.remove(f)),b++,L.remove_permission().done(f),b++,p.factoryReset().always(f));f()},reset:function(a){ea.run(null,
a)},factoryReset:function(a){ea.run("factory",a)},configReset:function(a){ea.run("config",a)}},W=function(){var a=function(){chrome.runtime&&chrome.runtime.lastError&&void 0},c={},b={},f=function(a){var b=0,c=function(){D&&console.log("badge: set "+b);b?chrome.browserAction.setBadgeText({text:b.toString(),tabId:a}):chrome.browserAction.setBadgeText({text:"",tabId:a})};if("off"==h.values.appearance_badges)b=0;else if("running"==h.values.appearance_badges)a&&!y.get.empty(a)&&(b=y.get.stats(a).running);
else if("running_unique"==h.values.appearance_badges)a&&!y.get.empty(a)&&(b=y.get.stats(a,!0).unique);else if("disabled"==h.values.appearance_badges)a&&!y.get.empty(a)&&(b=y.get.stats(a).disabled);else if("tamperfire"==h.values.appearance_badges){var f=function(a){b=a;c()};if(!F.isReady()){f("?");return}F.tab.getCount(a,f);return}c()},l={init:function(){l.setIcon();chrome.browserAction.setBadgeBackgroundColor&&"gcal"===n.SELF.ID.substr(0,4)&&chrome.browserAction.setBadgeBackgroundColor({color:"#444"})},
setIcon:function(c,f){b[c]&&window.clearTimeout(b[c]);b[c]=window.setTimeout(function(){var l=f;void 0==l&&(l=h);var k;k=null;var n=!1,p=!1,r=!!y.get.empty(c);c&&!r&&(n=y.get.blocker(c),p=y.get.forbidden(c));p?(l.images.icon="images/icon_forbidden.png",k=e.getMessage("At_least_one_part_of_this_page_is_listed_at_the_forbidden_pages_setting_")):n?(l.images.icon="images/icon_blocker.png",k=e.getMessage("Some_scripts_might_be_blocked_by_the_javascript_settings_for_this_page_or_a_script_blocker_")):l.images.icon=
h.values.enabled&&!r?"images/icon.png":"images/icon_grey.png";l={path:chrome.extension.getURL(l.images.icon)};k={title:k?k:chrome.extension.manifest.name};null!=c&&(l.tabId=c,k.tabId=c);try{chrome.browserAction.setIcon(l,a),chrome.browserAction.setTitle(k)}catch(q){console.warn("bg: ERROR while setIcon! "+q.message)}delete b[c]},500)},setBadge:function(a){c[a]&&window.clearTimeout(c[a]);c[a]=window.setTimeout(function(){f(a);delete c[a]},500)}};return l}(),A={infoChanged:[],redirects:{},addInfoChangedListener:function(a){A.infoChanged.push(a)},
runInfoChangedListener:function(){for(var a=0;a<A.infoChanged.length;a++)A.infoChanged[a](G)},detectRedirectToCache:function(a){C.registerLateCallback(function(){A.detectRedirect(a)})},detectRedirect:function(a){var c=a.responseHeaders||[],b=a.requestId,f=!1,e=!1,d=!1,g="xmlhttprequest"==a.type,m="main_frame"==a.type||"sub_frame"==a.type;if(!g&&!m&&"no"==h.values.webrequest_fixCSP)return{};g&&A.redirects[b]&&(f=!0);for(var k={},p=0;p<c.length;p++){var t=c[p];if(t.name){var r=t.name.toLowerCase();
if("location"==r)if(m)e=!0;else{if(g){(function(){f&&window.clearTimeout(A.redirects[b].to);A.redirects[b]={url:t.value,to:window.setTimeout(function(){delete A.redirects[b]},1E4)}})();break}}else!m||"yes"!=h.values.webrequest_fixCSP||"x-webkit-csp"!=r&&"x-content-security-policy"!=r&&"content-security-policy"!=r||(r=35>n.RUNTIME.BROWSER_VERSION?t.value.replace(/script-src /,"script-src "+n.REQUESTS.INTERNAL_PAGE_URL+n.SELF.ID+" 'unsafe-inline' 'unsafe-eval' "):t.value.replace(/script-src /,"script-src 'unsafe-eval' "),
k[p]={name:t.name,value:r})}}if(m&&!e){if(y.events.response(a.tabId,a.frameId,a.url)){var d=!0,q;for(q in k)D&&console.log("csp: replace ",c[q],"with",k[q]),c[q]=k[q]}}else g&&f&&(c.push({name:"TM-finalURL",value:A.redirects[b].url}),d=!0);return d?{responseHeaders:c}:{}},headerFix:function(a){var c="main_frame"==a.type,b=I.runCheck;(c||"sub_frame"==a.type)&&b&&(b=B.parse(a.url).origin+"/*",chrome.contentSettings.javascript.set({primaryPattern:b,setting:"allow"}));var b=c&&y.get.user_agent(a.tabId,
a.frameId),f=G.headers&&"xmlhttprequest"==a.type;if(!b&&!f)return{};var e=!1,c={},d=[],g=RegExp("^"+G.prefix),h;b&&(h=y.get.user_agent(a.tabId,a.frameId));a=a.requestHeaders||[];for(var k=0;k<a.length;k++){var n=a[k];n.name&&(f&&0==n.name.search(g)?d.push(n):b&&"user-agent"==n.name.toLowerCase()?(e=!0,c[n.name]=h):c[n.name]=n.value)}if(f)for(k=0;k<d.length;k++)n=d[k],e=!0,c[n.name.replace(g,"")]=n.value;if(e){h=[];for(var p in c)c.hasOwnProperty(p)&&""!=p&&h.push({name:p,value:c[p]});return{requestHeaders:h}}return{}},
sucRequest:function(a){0<a.tabId&&console.log("bg: "+a.requestId+" print "+a.type+" request of tabId "+a.tabId+" to "+a.url)},checkRequestForUserscript:function(a){if(0<a.tabId&&"POST"!=a.method&&wa.isScriptUrl(a.url))return u.installFromUrl(a.url,{},{silent_fail:!0}).fail(function(){chrome.tabs.update(a.tabId,{url:a.url+"#bypass=true"},function(){})}),{redirectUrl:"javascript:history.back()"};y.events.reset(a.tabId,!0);y.events.request(a.tabId,a.frameId,a.url);return{}},removeWebRequestListeners:function(){if(G.use)try{A.preCleanup(),
chrome.webRequest.onBeforeRequest.removeListener(A.checkRequestForUserscript),chrome.webRequest.onBeforeSendHeaders.removeListener(A.headerFix),chrome.webRequest.onHeadersReceived.removeListener(A.detectRedirect)}catch(a){}G.headers=!1;A.runInfoChangedListener()},preInit:function(){G.use&&(A.tmp_cache=!0,chrome.webRequest.onHeadersReceived.addListener(A.detectRedirectToCache,{urls:["http://*/*","https://*/*"]},["responseHeaders","blocking"]),chrome.webRequest.handlerBehaviorChanged())},preCleanup:function(){G.use&&
A.tmp_cache&&(chrome.webRequest.onHeadersReceived.removeListener(A.detectRedirectToCache),delete A.tmp_cache)},init:function(a){if(G.use)try{A.preCleanup(),chrome.webRequest.onBeforeRequest.addListener(A.checkRequestForUserscript,{urls:["http://*/*","https://*/*","file://*/*"],types:["main_frame"]},["blocking"]),chrome.webRequest.onBeforeSendHeaders.addListener(A.headerFix,{urls:["http://*/*","https://*/*","file://*/*"]},["requestHeaders","blocking"]),chrome.webRequest.onHeadersReceived.addListener(A.detectRedirect,
{urls:["http://*/*","https://*/*"]},["responseHeaders","blocking"]),chrome.webRequest.handlerBehaviorChanged(),G.headers=a,G.id=s.createUUID(),G.testprefix=G.prefix+s.createUUID(),G.prefix=G.prefix+G.id+"_",A.runInfoChangedListener()}catch(c){D&&console.error("bg: error initializing webRequests "+c.message),A.removeWebRequestListeners()}},finalize:function(){A.removeWebRequestListeners()}},oa={retries:5,onCommitedListener:function(a){y.events.commited(a.tabId,a.frameId,a.url)},wait:function(){chrome.webNavigation&&
chrome.webNavigation.onCommitted?chrome.webNavigation.onCommitted.addListener(oa.onCommitedListener):n.RUNTIME.OPERA||0==oa.retries--||(D&&console.log("bg: waitForWebNav()"),window.setTimeout(oa.wait,300))}},C={late:!1,callbacks:[],init:function(){},registerLateCallback:function(a){D&&console.log("toea: register callback");C.callbacks.push(a)},setReady:function(){D&&console.debug("toea: run "+C.callbacks.length+" callbacks");C.late=!0;for(var a=0;a<C.callbacks.length;a++)C.callbacks[a]();C.callbacks=
[]}},Na=function(){var a=!1,c=null,b=function(){a||(D&&console.debug("Unloader.onbeforeunload()"),c&&c(),a=!0)};return{init:function(a){c=a;window.addEventListener("beforeunload",b,!1)}}}(),Fa=function(){var a=chrome.extension.getVersion(),c=null,b=!1,f=!1,l=function(){if(C.late){var d="version="+a+"&ext="+n.SELF.ID.substr(0,4)+"&updated=true",g;b?(g="http://tampermonkey.net/installed.php?"+d,f=!0):(d+="&old="+c,g="http://tampermonkey.net/changelog.php?"+d);"off"!=h.values.notification_showUpdate&&
("notification"==h.values.notification_showUpdate?N.showUpdate(e.getMessage("Updated_to__0version0",a),e.getMessage("Click_here_to_see_the_recent_changes"),chrome.extension.getURL("images/icon128.png"),function(a){a.clicked&&chrome.tabs.create({url:g},function(){})}):"changelog"==h.values.notification_showUpdate&&(f||(g+="&intr=true"),f=!0,chrome.tabs.create({url:g,active:f},function(){})))}else C.registerLateCallback(l)},d=function(){var a=null,b,c=v(),d=function(d){b&&(d||null!==a)&&(d||window.clearTimeout(b),
b=null,c.resolve(!!a))};chrome.idle.queryState(n.MISC.IDLE_TIMEOUT,function(b){a="active"==b;d()});b=window.setTimeout(function(){d(!0)},300);return c.promise()},g=function(a){C.late?(D&&console.log("upd: onInstalled",a),a||(a={reason:"mandatory_argument_is_not_set"}),"chrome_update"==a.reason?h.values.statistics_enabled&&Z.tB({updated:!0}):"install"!=a.reason&&"update"!=a.reason||r.scheduleNotification(a.previousVersion,"install"==a.reason)):C.registerLateCallback(function(){g(a)})},m=function(){var a=
v(),b=function(){var b=(new Date).getTime(),c=p.getValue(n.CONSTANTS.STORAGE.LAST_START,0),b=Math.round((b-c)/1E3),c=b<=n.MISC.DISTURBANCE_ALLOWED;D&&console.log("upd: restart?",c,"(",b,"seconds ago)");a.resolve(c)};C.late?b():C.registerLateCallback(b);return a.promise()}(),k=function(){var a=!1,b=!1;d().then(function(a){b=a;return m}).then(function(b){a=b}).always(function(){f=!b||a;l();t=!0})},s=null,t=!1,r={scheduleNotification:function(a,d){t||(c=a,b|=d,s&&window.clearTimeout(s),s=window.setTimeout(k,
1E3))}},q=function(a){console.log("An update to version",a.version,"is available");window.setTimeout(function(){N.show(e.getMessage("Update"),e.getMessage("0name0_0version0_is_available__Please_re_start_your_browser_to_update_",chrome.extension.manifest.name,a.version),chrome.extension.getURL("images/icon128.png"),6E4)},864E5)};chrome.runtime&&chrome.runtime.onInstalled&&chrome.runtime.onInstalled.addListener(g);chrome.runtime&&chrome.runtime.onUpdateAvailable&&chrome.runtime.onUpdateAvailable.addListener(q);
(function(){C.registerLateCallback(function(){p.setValue(n.CONSTANTS.STORAGE.LAST_START,(new Date).getTime())})})();return r}(),Ca=function(a,c,b){C.late?(wa.isScriptUrl(b.url)&&u.installFromUrl(b.url),"loading"==c.status?y.events.loading(b.id,0,b.url):"complete"==c.status&&y.events.complete(b.id,0,b.url)):window.setTimeout(function(){Ca(a,c,b)},100)},Oa=function(a,c){Da(c,{});W.setIcon(a);W.setBadge(a)},Da=function(a,c){ca[a]&&(ca[a].onClose(),delete ca[a]);y.events.remove(a)},ya=function(){var a=
"temporary"==h.values.incognito_mode&&chrome.extension.inIncognitoContext;p.setTemporary(a);a&&(h.values.native_import=!1,h.values.sync_enabled=!1,h.values.fire_updatePeriod=0,h.values.scriptUpdateCheckPeriod=0,h.values.sync_type=0,h.values.statistics_enabled=!1)},Pa=function(){sa(h.values.logLevel);e.setLocale(h.values.i18n);P.setPath(h.values.native_import_path);h.values.statistics_enabled&&(Z.init(),window.onerror=function(a,b,e,h,d){Z.tE(a,chrome.extension.manifest.version+" bg@"+b,[e+":"+h,d?
d.stack:""].join(";"))});I.init();y.listeners.add.onReset(function(a,b){E.clearByTabId(a);z.removeStorageListeners({tabid:a},!1);b||W.setIcon(a)});var a=function(a){W.setIcon(a);W.setBadge(a)};y.listeners.add.onCommited(a);y.listeners.add.onCompleted(a);J.init().done(function(a){a&&J.sync()});h.values.fire_enabled&&F.init();da.init();z.init();a=function(){L.set_mode(h.values.downloads_mode);L.set_whitelist(h.values.downloads_extension_whitelist)};a();L.config_changed_listener=a;A.addInfoChangedListener(function(a){pa&&
pa.setWebRequest(a)});A.init("no"!=h.values.webrequest_modHeaders)},B=Registry.get("uri"),L=Registry.get("downloads");uris=B;down=L;var M,ga,pa,ma,Y,K,e,ha;init=function(){C.init();A.preInit();chrome.tabs.onUpdated.addListener(Ca);chrome.tabs.onReplaced&&chrome.tabs.onReplaced.addListener(Oa);chrome.tabs.onRemoved.addListener(Da);chrome.extension.onMessage.addListener(ia.handler);chrome.extension.onConnect.addListener(Ba);chrome.extension.onConnectExternal.addListener(function(a){a.disconnect()});
Na.init(function(){A.finalize();J.finalize()});M=Registry.get("convert");e=Registry.get("i18n");pa=Registry.get("xmlhttprequest");ga=pa.run;ma=Registry.get("compat",n);Y=Registry.get("parser");K=Registry.get("syncinfo");ha=Registry.get("test");chrome.browserAction.setIcon({path:chrome.extension.getURL("images/icon_grey.png")});chrome.browserAction.setPopup({popup:"action.html"});chrome.browserAction.setTitle({title:"Tampermonkey"});p.init().then(function(){return Ga()}).then(function(){return h.init()}).then(function(){cfgo=
h;ya();Pa();Ja();W.init();window.setTimeout(aa.check,1E4);oa.wait();D&&console.debug("Listeners registered!");window.setTimeout(C.setReady,1);if(ha&&Registry.isDevVersion("test")){var a=ha.framework.prepare(u.doSave);a&&console.error(a)}})};init()}});
